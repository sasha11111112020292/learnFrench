<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Maison Â· French Sanctuary</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Work+Sans:wght@300;400;500&family=Allura&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD5l89evtb8svRKoTVICAVwA4JbpoXjJKQ",
            authDomain: "ma-maison-french.firebaseapp.com",
            projectId: "ma-maison-french",
            storageBucket: "ma-maison-french.firebasestorage.app",
            messagingSenderId: "319573050083",
            appId: "1:319573050083:web:11ff8453f39cce3160fbd6",
            measurementId: "G-JP9BNPQX0B"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseModules = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            collection,
            doc,
            setDoc,
            getDoc,
            getDocs,
            deleteDoc,
            onSnapshot,
            query,
            where
        };
        
        // Signal that Firebase is ready
        window.firebaseReady = true;
        console.log('âœ… Firebase loaded and ready!');
        
        // Trigger initialization immediately if function exists
        if (window.initFirebaseAuth) {
            console.log('ðŸš€ Calling initFirebaseAuth immediately');
            window.initFirebaseAuth();
        } else {
            // Otherwise wait for DOM and try again
            console.log('â³ Waiting for initFirebaseAuth function...');
            const checkInit = setInterval(() => {
                if (window.initFirebaseAuth) {
                    console.log('ðŸš€ Found initFirebaseAuth, calling now');
                    clearInterval(checkInit);
                    window.initFirebaseAuth();
                }
            }, 100);
        }
    </script>
    
    <style>
        :root {
            --cream: #FBF9F4;
            --cream-dark: #F5F1E8;
            --crimson: #8B2635;
            --crimson-soft: #A64253;
            --navy: #1B2B3A;
            --navy-soft: #2C3E50;
            --gold: #C9A861;
            --gold-pale: #E5D4A6;
            --text: #2A2520;
            --text-soft: #6B615C;
            --whisper: rgba(42, 37, 32, 0.04);
            --shadow: rgba(27, 43, 58, 0.08);
            --shadow-strong: rgba(27, 43, 58, 0.15);
            --rosy: #D4A5A5;
            --sage: #A8B8A8;
        }

        /* Dark mode variables - Rich, sophisticated night theme */
        body.dark-mode {
            --cream: #0d1117;
            --cream-dark: #161b22;
            --crimson: #ff6b8a;
            --crimson-soft: #ff8fab;
            --navy: #e8dcc8;
            --navy-soft: #c9b8a0;
            --gold: #f4d58d;
            --gold-pale: #d4b886;
            --text: #e8dcc8;
            --text-soft: #9d8e7a;
            --whisper: rgba(232, 220, 200, 0.08);
            --shadow: rgba(0, 0, 0, 0.5);
            --shadow-strong: rgba(0, 0, 0, 0.7);
            --rosy: #d4969d;
            --sage: #9fb99f;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #1a1f26 100%);
        }

        body.dark-mode .header {
            background: rgba(22, 27, 34, 0.95);
            border-bottom-color: rgba(232, 220, 200, 0.1);
        }

        body.dark-mode .nav {
            border-bottom-color: rgba(232, 220, 200, 0.1);
        }

        body.dark-mode .word-card,
        body.dark-mode .entrance-card,
        body.dark-mode .reading-card,
        body.dark-mode .listening-card,
        body.dark-mode .recording-card,
        body.dark-mode .writing-card,
        body.dark-mode .note-card,
        body.dark-mode .resource-card {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid rgba(232, 220, 200, 0.12);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .word-card:hover,
        body.dark-mode .reading-card:hover,
        body.dark-mode .listening-card:hover,
        body.dark-mode .recording-card:hover,
        body.dark-mode .writing-card:hover,
        body.dark-mode .note-card:hover,
        body.dark-mode .resource-card:hover {
            border-color: rgba(244, 213, 141, 0.3);
            box-shadow: 0 8px 24px rgba(244, 213, 141, 0.15);
        }

        /* ====== SVG ANIMATIONS ====== */
        .animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        /* Floating Hearts */
        .floating-heart {
            position: absolute;
            bottom: -50px;
            animation: floatUp 4s ease-in-out forwards;
            opacity: 0;
        }
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #d4746f 0%, #b85d5d 100%);
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(212, 116, 111, 0.3);
        }

        body.dark-mode .btn-primary:hover {
            background: linear-gradient(135deg, #e08882 0%, #c96b6b 100%);
            box-shadow: 0 6px 16px rgba(212, 116, 111, 0.4);
        }

        /* Comprehensive dark mode: Override ALL white backgrounds */
        body.dark-mode .affirmation,
        body.dark-mode .heart-note,
        body.dark-mode .modal-content,
        body.dark-mode .filter-bar,
        body.dark-mode .stat-card,
        body.dark-mode .srs-stat-box,
        body.dark-mode .srs-card-container,
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea,
        body.dark-mode .srs-diff-btn,
        body.dark-mode .garden-summary,
        body.dark-mode .pdf-page {
            background: rgba(22, 27, 34, 0.9) !important;
        }

        body.dark-mode .btn-secondary {
            background: rgba(232, 220, 200, 0.1);
            border: 1px solid rgba(232, 220, 200, 0.2);
            color: var(--gold);
        }

        body.dark-mode .btn-secondary:hover {
            background: rgba(232, 220, 200, 0.15);
            border-color: rgba(232, 220, 200, 0.3);
        }

        body.dark-mode .icon-btn {
            background: rgba(232, 220, 200, 0.08);
            color: var(--gold);
        }

        body.dark-mode .icon-btn:hover {
            background: rgba(232, 220, 200, 0.15);
        }

        body.dark-mode .modal-content {
            background: #161b22;
            border: 1px solid rgba(232, 220, 200, 0.15);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-textarea,
        body.dark-mode .form-select {
            background: rgba(13, 17, 23, 0.6);
            border-color: rgba(232, 220, 200, 0.15);
            color: var(--text);
        }

        body.dark-mode .form-input:focus,
        body.dark-mode .form-textarea:focus,
        body.dark-mode .form-select:focus {
            border-color: var(--gold);
            background: rgba(13, 17, 23, 0.8);
        }

        body.dark-mode .category-tag {
            background: rgba(244, 213, 141, 0.15);
            border: 1px solid rgba(244, 213, 141, 0.3);
            color: var(--gold);
        }

        body.dark-mode .affirmation {
            background: rgba(22, 27, 34, 0.95);
            border-left-color: var(--gold);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .game-section {
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(232, 220, 200, 0.12);
        }

        body.dark-mode .empty {
            color: var(--text-soft);
        }

        /* === SRS SYSTEM STYLES === */
        .srs-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .srs-stat-box {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 2px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
            border-left: 3px solid var(--gold);
        }

        body.dark-mode .srs-stat-box {
            background: rgba(22, 27, 34, 0.8);
        }

        .srs-stat-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            color: var(--crimson);
            font-weight: 500;
        }

        .srs-stat-label {
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .srs-card-container {
            background: var(--cream);
            border-radius: 12px;
            padding: 3rem;
            box-shadow: 0 4px 20px var(--shadow);
            min-height: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin: 2rem auto;
            max-width: 700px;
        }

        body.dark-mode .srs-card-container {
            background: rgba(22, 27, 34, 0.8);
        }

        .srs-card-word {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 500;
            color: var(--crimson);
            margin-bottom: 1.5rem;
        }

        .srs-card-translation {
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .srs-card-container.revealed .srs-card-translation {
            opacity: 1;
        }

        .srs-card-example {
            font-size: 1.1rem;
            color: var(--text-soft);
            font-style: italic;
            padding: 1.5rem;
            background: var(--whisper);
            border-radius: 8px;
            max-width: 550px;
            margin: 1.5rem auto;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .srs-card-container.revealed .srs-card-example {
            opacity: 1;
        }

        .srs-difficulty-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 500px;
            margin-top: 2rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .srs-card-container.revealed .srs-difficulty-buttons {
            opacity: 1;
        }

        .srs-diff-btn {
            padding: 1rem;
            border: 2px solid;
            border-radius: 8px;
            background: var(--cream);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        body.dark-mode .srs-diff-btn {
            background: var(--cream-dark);
        }

        .srs-diff-btn small {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .srs-diff-btn.again {
            border-color: #dc3545;
            color: #dc3545;
        }

        .srs-diff-btn.again:hover {
            background: #dc3545;
            color: white;
        }

        .srs-diff-btn.hard {
            border-color: #fd7e14;
            color: #fd7e14;
        }

        .srs-diff-btn.hard:hover {
            background: #fd7e14;
            color: white;
        }

        .srs-diff-btn.good {
            border-color: #28a745;
            color: #28a745;
        }

        .srs-diff-btn.good:hover {
            background: #28a745;
            color: white;
        }

        .srs-diff-btn.easy {
            border-color: #007bff;
            color: #007bff;
        }

        .srs-diff-btn.easy:hover {
            background: #007bff;
            color: white;
        }

        .srs-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--whisper);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .srs-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--crimson), var(--gold));
            transition: width 0.3s;
        }

        .srs-progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-soft);
            margin-bottom: 1rem;
        }

        .srs-complete-message {
            text-align: center;
            padding: 3rem;
        }

        .srs-complete-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .srs-complete-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            color: var(--crimson);
            margin-bottom: 1rem;
        }

        .srs-complete-subtitle {
            font-size: 1.2rem;
            color: var(--text-soft);
            margin-bottom: 2rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--cream);
            color: var(--text);
            line-height: 1.7;
            font-weight: 300;
            overflow-x: hidden;
        }

        /* Affirmation */
        .affirmation {
            position: fixed;
            top: 20%;
            right: 3rem;
            max-width: 280px;
            padding: 1.5rem;
            background: var(--cream);
            border-left: 2px solid var(--gold);
            box-shadow: 0 4px 20px var(--shadow);
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            z-index: 1000;
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .affirmation.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .affirmation-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .affirmation-translation {
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        /* Floating Heart */
        .floating-heart {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            opacity: 0.2;
            z-index: 1;
            animation: heartPulse 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes heartPulse {
            0%, 100% { transform: scale(1); opacity: 0.2; }
            50% { transform: scale(1.08); opacity: 0.3; }
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--cream);
            border: 1px solid var(--whisper);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        body.dark-mode .dark-mode-toggle {
            background: var(--cream-dark);
            border-color: var(--whisper);
        }

        .dark-mode-toggle:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px var(--shadow-strong);
        }

        .dark-mode-toggle svg {
            width: 24px;
            height: 24px;
            transition: all 0.4s ease;
        }

        .dark-mode-toggle .sun-icon {
            display: none;
        }

        body.dark-mode .dark-mode-toggle .sun-icon {
            display: block;
        }

        body.dark-mode .dark-mode-toggle .moon-icon {
            display: none;
        }

        /* Floating Quick Actions */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .floating-btn-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--crimson);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(139, 38, 53, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .floating-btn-main:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 28px rgba(139, 38, 53, 0.6);
        }

        .floating-btn-main svg {
            width: 24px;
            height: 24px;
            stroke: white;
            position: absolute;
            transition: all 0.3s ease;
        }

        .floating-btn-main .close-icon {
            opacity: 0;
            transform: rotate(-90deg);
        }

        .floating-actions.active .floating-btn-main .plus-icon {
            opacity: 0;
            transform: rotate(90deg);
        }

        .floating-actions.active .floating-btn-main .close-icon {
            opacity: 1;
            transform: rotate(0);
        }

        .floating-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-actions.active .floating-menu {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .floating-btn-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            background: var(--cream);
            border: 1px solid var(--whisper);
            border-radius: 28px;
            cursor: pointer;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            color: var(--navy);
        }

        .floating-btn-action:hover {
            background: var(--cream-dark);
            transform: translateX(-4px);
            box-shadow: 0 6px 24px var(--shadow-strong);
        }

        .floating-btn-action svg {
            width: 20px;
            height: 20px;
            stroke: var(--crimson);
            fill: none;
            flex-shrink: 0;
        }

        body.dark-mode .floating-btn-main {
            background: var(--gold);
            box-shadow: 0 4px 20px rgba(244, 213, 141, 0.4);
        }

        body.dark-mode .floating-btn-main:hover {
            box-shadow: 0 6px 28px rgba(244, 213, 141, 0.6);
        }

        body.dark-mode .floating-btn-main svg {
            stroke: var(--navy);
        }

        body.dark-mode .floating-btn-action {
            background: var(--cream-dark);
            border-color: rgba(232, 220, 200, 0.15);
        }

        body.dark-mode .floating-btn-action:hover {
            background: rgba(22, 27, 34, 0.9);
            border-color: rgba(244, 213, 141, 0.3);
        }

        body.dark-mode .floating-btn-action svg {
            stroke: var(--gold);
        }

        /* Header */
        .header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--whisper);
            background: rgba(251, 249, 244, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            flex-direction: column;
        }

        .logo-main {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.75rem;
            font-weight: 400;
            color: var(--crimson);
            letter-spacing: 0.02em;
        }

        .logo-sub {
            font-size: 0.7rem;
            color: var(--text-soft);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        .signature {
            font-family: 'Allura', cursive;
            font-size: 2rem;
            color: var(--gold);
            opacity: 0.7;
            cursor: pointer;
            transition: all 0.5s ease;
        }

        .signature:hover {
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 2rem 1rem;
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--whisper);
            overflow-x: auto;
        }

        .nav-link {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-soft);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--crimson);
        }

        .nav-link.active {
            color: var(--navy);
            border-bottom-color: var(--crimson);
        }

        /* Main */
        .main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 3rem 2rem 5rem;
        }

        .room {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }

        .room.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .room-intro {
            text-align: center;
            max-width: 650px;
            margin: 0 auto 3rem;
        }

        .room-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            font-weight: 400;
            color: var(--navy);
            margin-bottom: 1rem;
        }

        .room-description {
            font-size: 1rem;
            color: var(--text-soft);
            line-height: 1.8;
        }

        /* Cards */
        .entrance-card {
            background: var(--cream);
            padding: 3rem;
            border-radius: 2px;
            box-shadow: 0 4px 24px var(--shadow);
            margin-bottom: 2rem;
            border-top: 3px solid var(--gold);
        }

        .entrance-sentence {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.25rem;
            font-weight: 400;
            color: var(--navy);
            margin-bottom: 1rem;
            text-align: center;
        }

        .entrance-translation {
            font-size: 1.1rem;
            color: var(--text-soft);
            text-align: center;
            margin-bottom: 2rem;
        }

        .entrance-note {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text);
            padding: 1.5rem;
            background: var(--whisper);
            border-left: 2px solid var(--gold-pale);
        }

        /* Buttons */
        .data-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 2px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--navy);
            color: white;
        }

        .btn-primary:hover {
            background: var(--navy-soft);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--navy);
            border: 1px solid var(--navy);
        }

        .btn-secondary:hover {
            background: var(--cream-dark);
        }

        .timer-preset {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            min-width: auto;
        }

        .timer-preset.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        body.dark-mode .timer-preset.active {
            background: var(--gold);
            color: var(--navy);
            border-color: var(--gold);
        }

        .btn-danger {
            background: transparent;
            color: var(--crimson);
            border: 1px solid var(--crimson);
            font-size: 0.8rem;
        }

        .btn-danger:hover {
            background: var(--crimson);
            color: white;
        }

        .btn-drive {
            padding: 0.875rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--cream);
            color: var(--navy);
            border: 1px solid var(--navy);
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-drive:hover {
            background: var(--cream-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Word Grid */
        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .word-card {
            background: var(--cream);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 2px 12px var(--shadow);
            border-left: 3px solid var(--gold);
            position: relative;
        }

        .word-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .icon-btn {
            background: var(--cream);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 0.25rem;
            border-radius: 2px;
        }

        .icon-btn:hover {
            opacity: 1;
        }

        .icon-btn.favorite-active {
            opacity: 1;
        }

        .icon-btn.favorite-active:hover {
            transform: scale(1.1);
        }

        .word-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 1rem;
        }

        /* View Toggle */
        .view-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        .view-toggle.active {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        body.dark-mode .view-toggle.active {
            background: var(--gold);
            color: var(--navy);
            border-color: var(--gold);
        }

        /* Flip Cards */
        .flip-card-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            margin: 2rem 0;
            perspective: 1000px;
        }

        .flip-card {
            width: 100%;
            max-width: 600px;
            height: 400px;
            cursor: pointer;
            position: relative;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .flip-card-front {
            background: linear-gradient(135deg, white 0%, var(--cream-dark) 100%);
            border: 2px solid var(--gold);
        }

        .flip-card-back {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-soft) 100%);
            color: white;
            transform: rotateY(180deg);
        }

        body.dark-mode .flip-card-front {
            background: linear-gradient(135deg, var(--cream-dark) 0%, #1a1f26 100%);
            border-color: var(--gold);
        }

        body.dark-mode .flip-card-back {
            background: linear-gradient(135deg, var(--gold) 0%, #d4b886 100%);
            color: var(--navy);
        }

        .flip-card-content {
            text-align: center;
            width: 100%;
        }

        .flip-card-word {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 500;
            color: var(--navy);
            margin-bottom: 1rem;
        }

        body.dark-mode .flip-card-word {
            color: var(--gold);
        }

        .flip-card-hint {
            font-size: 0.9rem;
            color: var(--text-soft);
            font-style: italic;
        }

        .flip-card-meaning {
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .flip-card-example {
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0.9;
            line-height: 1.6;
        }

        .flip-card-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
        }

        .flip-card-counter {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }

        .word-french {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.75rem;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .word-meaning {
            font-size: 1rem;
            color: var(--navy-soft);
            margin-bottom: 1rem;
            font-weight: 400;
            font-style: italic;
        }

        .word-article {
            font-size: 0.85rem;
            color: var(--text-soft);
            margin-bottom: 1rem;
        }

        .word-contexts {
            margin: 1rem 0;
        }

        .context {
            margin-bottom: 1rem;
        }

        .context-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gold);
            margin-bottom: 0.25rem;
        }

        .context-sentence {
            font-size: 0.95rem;
            color: var(--text);
            font-style: italic;
        }

        .word-note {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--whisper);
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        /* Categories Grid */
        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .category-tag {
            display: inline-block;
            background: var(--whisper);
            color: var(--text-soft);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            letter-spacing: 0.03em;
        }

        .category-tag.topic {
            background: var(--gold-pale);
            color: var(--navy);
        }

        .category-tag.time {
            background: var(--sage);
            color: white;
            font-size: 0.7rem;
        }

        .empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-text {
            font-size: 1rem;
            color: var(--text-soft);
            line-height: 1.8;
        }

        /* Game section */
        .game-section {
            background: var(--cream);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
            border-top: 3px solid var(--crimson);
        }

        .game-container {
            margin-top: 1.5rem;
        }

        .game-mode-btn {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .game-mode-btn svg {
            flex-shrink: 0;
        }

        .game-mode-btn.active {
            background: var(--crimson);
            color: white;
            border-color: var(--crimson);
        }

        .game-instructions {
            font-size: 1rem;
            color: var(--text-soft);
            margin-bottom: 1.5rem;
            font-style: italic;
        }

        .matching-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .matching-card {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--whisper);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            color: var(--navy);
            font-family: 'Cormorant Garamond', serif;
        }

        .matching-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .matching-card.selected {
            background: var(--gold-pale);
            border-color: var(--gold);
        }

        .matching-card.matched {
            background: #e8f5e8;
            border-color: #7fa87f;
            cursor: default;
            opacity: 0.6;
        }

        .matching-card.wrong {
            background: #ffe8e8;
            border-color: var(--crimson);
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fillblank-option {
            padding: 0.75rem 1.5rem;
            background: var(--cream);
            border: 2px solid var(--whisper);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            color: var(--navy);
        }

        .fillblank-option:hover {
            border-color: var(--gold);
            background: var(--gold-pale);
        }

        .fillblank-option.correct {
            background: #e8f5e8;
            border-color: #7fa87f;
            cursor: default;
        }

        .fillblank-option.incorrect {
            background: #ffe8e8;
            border-color: var(--crimson);
            animation: shake 0.4s;
        }

        .game-result {
            margin-top: 1.5rem;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .game-word {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .game-prompt {
            font-size: 0.95rem;
            color: var(--text-soft);
            font-style: italic;
        }

        /* Resource cards */
        .resource-grid {
            display: grid;
            gap: 1rem;
        }

        .resource-card {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 2px;
            box-shadow: 0 2px 8px var(--shadow);
            border-left: 3px solid var(--crimson);
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 1rem;
        }

        .resource-info {
            flex: 1;
        }

        .resource-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .resource-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
            color: var(--navy);
            margin-bottom: 0.25rem;
        }

        .resource-link {
            font-size: 0.85rem;
            color: var(--text-soft);
            word-break: break-all;
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
        }

        .resource-link:hover {
            color: var(--crimson);
            text-decoration: underline;
        }

        .resource-note {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text);
            font-style: italic;
        }

        .resource-status {
            font-size: 0.8rem;
            color: var(--text-soft);
            margin-top: 0.5rem;
        }

        /* PDF Save Button */
        .pdf-save-btn {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--crimson);
            color: white;
            border: none;
            box-shadow: 0 4px 12px var(--shadow-strong);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .pdf-save-btn:hover {
            background: var(--crimson-soft);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-strong);
        }

        .pdf-save-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* Stack export buttons vertically */
        #save-words-csv {
            bottom: 6.5rem !important;
            left: 2rem !important;
            right: auto !important;
            background: var(--navy);
        }
        
        #save-words-csv:hover {
            background: var(--navy-soft);
        }
        
        #bulk-import-btn {
            bottom: 11rem !important;
            left: 2rem !important;
            right: auto !important;
            background: var(--gold);
        }
        
        #bulk-import-btn:hover {
            background: var(--gold-pale);
            color: var(--text);
        }

        /* Transcript/Lyrics Button */
        .transcript-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold-pale);
            color: var(--navy);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .transcript-btn:hover {
            background: var(--gold);
            transform: scale(1.05);
        }

        .transcript-btn svg {
            width: 20px;
            height: 20px;
        }

        .resource-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Speaking recordings */
        .recording-card {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 2px;
            box-shadow: 0 2px 8px var(--shadow);
            border-left: 3px solid var(--gold);
            margin-bottom: 1rem;
        }

        .recording-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .recording-date {
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        .recording-transcript {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
            color: var(--navy);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        .recording-note {
            font-size: 0.9rem;
            color: var(--text);
            padding: 1rem;
            background: var(--whisper);
            border-left: 2px solid var(--gold-pale);
        }

        /* Transcript Cards */
        .transcript-card {
            background: var(--cream);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 2px 8px var(--shadow);
            border-left: 3px solid var(--crimson);
            margin-bottom: 1.5rem;
        }

        body.dark-mode .transcript-card {
            background: rgba(22, 27, 34, 0.8);
            border-left-color: var(--crimson);
        }

        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .transcript-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--navy);
            font-weight: 500;
        }

        .transcript-body {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--text);
        }

        .clickable-word {
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px dotted transparent;
            padding: 0 2px;
        }

        .clickable-word:hover {
            background: var(--gold-pale);
            border-bottom-color: var(--gold);
            color: var(--navy);
        }

        body.dark-mode .clickable-word:hover {
            background: rgba(244, 213, 141, 0.2);
            border-bottom-color: var(--gold);
        }

        .lookup-info {
            padding: 1rem 0;
        }

        .lookup-lemma {
            font-size: 1rem;
            color: var(--text-soft);
            margin-bottom: 0.5rem;
        }

        .lookup-ipa {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 1rem;
        }

        .lookup-translations {
            list-style: none;
            padding: 0;
        }

        .lookup-translations li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--whisper);
        }

        .lookup-translations li:last-child {
            border-bottom: none;
        }

        .lookup-sentence {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--whisper);
            border-left: 3px solid var(--gold);
            font-style: italic;
            color: var(--text-soft);
        }

        /* Notes section */
        #notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .note-card {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 2px;
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-strong);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-category {
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            border-radius: 2px;
        }

        .note-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--navy);
            line-height: 1.3;
        }

        .note-content {
            font-size: 0.95rem;
            color: var(--text);
            line-height: 1.6;
        }

        .note-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: var(--gold);
            text-decoration: none;
            transition: color 0.2s;
        }

        .note-link:hover {
            color: var(--crimson);
        }

        .note-date {
            font-size: 0.75rem;
            color: var(--text-soft);
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--whisper);
        }

        /* Writings archive */
        .writing-card {
            background: var(--cream);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 2px 8px var(--shadow);
            border-left: 3px solid var(--navy);
            margin-bottom: 1rem;
        }

        .writing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--whisper);
        }

        .writing-date {
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        .writing-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.15rem;
            line-height: 1.9;
            color: var(--text);
            white-space: pre-wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(27, 43, 58, 0.5);
            z-index: 200;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--cream);
            padding: 3rem;
            border-radius: 2px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px var(--shadow-strong);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--whisper);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.75rem;
            color: var(--navy);
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-soft);
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--crimson);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #DDD;
            border-radius: 2px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--gold);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .image-upload-area {
            border: 2px dashed #DDD;
            border-radius: 2px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: var(--gold);
            background: var(--whisper);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 1rem;
            border-radius: 2px;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Writing area */
        .writing-container {
            background: var(--cream);
            padding: 3rem;
            border-radius: 2px;
            box-shadow: 0 4px 24px var(--shadow);
            margin-bottom: 2rem;
        }

        .writing-area {
            width: 100%;
            min-height: 400px;
            padding: 2rem;
            border: 1px solid #EEE;
            border-radius: 2px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
            line-height: 2;
            color: var(--text);
            background: var(--cream);
            resize: vertical;
        }

        .writing-area:focus {
            outline: none;
            border-color: var(--gold);
        }

        body.dark-mode .writing-area {
            background: rgba(22, 27, 34, 0.6);
            border-color: rgba(232, 220, 200, 0.2);
        }

        body.dark-mode .writing-area:focus {
            border-color: var(--gold);
        }

        .writing-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .word-count {
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        /* Speaking section */
        #spoken-text {
            margin-top: 1.5rem;
            min-height: 60px;
            padding: 1rem;
            background: var(--whisper);
            border-left: 2px solid var(--gold);
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
        }

        .speaking-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Practice Stats */
        .practice-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: 2px;
            border-left: 3px solid var(--gold);
            text-align: center;
        }

        .stat-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            font-weight: 500;
            color: var(--crimson);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-soft);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .speaking-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--whisper);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-soft);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--navy);
        }

        .tab.active {
            color: var(--navy);
            border-bottom-color: var(--crimson);
        }

        .tab-content {
            display: none;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1.75rem;
            background: var(--cream);
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid rgba(201, 168, 97, 0.2);
        }

        .filter-tag {
            padding: 0.65rem 1.5rem;
            border: 2px solid var(--whisper);
            background: var(--cream);
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            border-radius: 24px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .filter-tag:hover {
            transform: translateY(-2px);
            border-color: var(--gold);
            background: var(--gold-pale);
            box-shadow: 0 4px 12px rgba(201, 168, 97, 0.2);
        }

        .filter-tag.active {
            background: var(--crimson);
            color: white;
            border-color: var(--crimson);
            box-shadow: 0 4px 16px rgba(139, 38, 53, 0.3);
            transform: translateY(-1px);
        }

        .filter-tag.active::after {
            content: 'âœ“';
            margin-left: 0.5rem;
            font-weight: 700;
        }

        /* Question Section (Parler) */
        .question-section {
            background: var(--cream);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid rgba(201, 168, 97, 0.2);
        }

        .question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--whisper);
        }

        .question-title {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold);
            margin: 0;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .doc-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: var(--whisper);
            color: var(--navy);
            text-decoration: none;
            border-radius: 8px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .doc-link:hover {
            background: var(--gold-pale);
            border-color: var(--gold);
            color: var(--crimson);
        }

        .doc-link svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .question-input {
            font-size: 1.15rem !important;
            font-family: 'Cormorant Garamond', serif !important;
            font-weight: 400;
            color: var(--navy) !important;
            padding: 1rem 1.25rem !important;
            border-radius: 12px !important;
            border: 2px solid var(--whisper) !important;
            background: var(--cream) !important;
            transition: all 0.3s ease !important;
        }

        .question-input:focus {
            border-color: var(--gold) !important;
            background: white !important;
            box-shadow: 0 0 0 4px rgba(201, 168, 97, 0.1) !important;
            outline: none !important;
        }

        .question-input::placeholder {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95rem;
            font-style: italic;
            color: var(--text-soft);
            opacity: 0.6;
        }

        /* Beautiful Speak Button */
        .btn-speak {
            display: inline-flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.85rem 1.75rem;
            background: var(--cream);
            color: var(--crimson);
            border: 2px solid var(--gold-pale);
            border-radius: 24px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 1.5rem;
        }

        .mic-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .btn-speak:hover {
            background: var(--gold-pale);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 168, 97, 0.3);
        }

        .btn-speak:active {
            transform: translateY(0);
        }

        .btn-speak.btn-danger {
            background: var(--crimson);
            color: white;
            border-color: var(--crimson);
        }

        .tab-content.active {
            display: block;
        }

        /* SVG Icons */
        .svg-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
            display: inline-block;
            vertical-align: middle;
        }

        .svg-icon-lg {
            width: 48px;
            height: 48px;
            fill: currentColor;
        }

        /* Heart Note */
        .heart-note {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--cream);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(139, 38, 53, 0.2);
            z-index: 10000;
            max-width: 320px;
            text-align: center;
            border-top: 4px solid var(--rosy);
            animation: heartNoteIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            display: none;
        }

        @keyframes heartNoteIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* HEATMAP CALENDAR */
        .heatmap-container {
            background: var(--cream);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 16px var(--shadow);
            margin-bottom: 2rem;
        }

        .heatmap-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--navy);
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            max-width: 600px;
        }

        .heatmap-day {
            aspect-ratio: 1;
            background: var(--whisper);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-day:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .heatmap-day[data-count="1"] { background: #fef3e8; }
        .heatmap-day[data-count="2"] { background: #fde8d0; }
        .heatmap-day[data-count="3"] { background: #f9d3ab; }
        .heatmap-day[data-count="4"] { background: #f4be86; }
        .heatmap-day[data-count="5"] { background: #efa961; }
        .heatmap-day[data-count="6"] { background: #e89442; }
        .heatmap-day[data-count="7"] { background: #df7f29; }
        .heatmap-day[data-count="8"] { background: #d46a16; }
        .heatmap-day[data-count="9"] { background: #c85a0c; }
        .heatmap-day[data-count="10"] { background: #b84d06; border: 2px solid var(--crimson); }

        .heatmap-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--navy);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .heatmap-day:hover .heatmap-tooltip {
            opacity: 1;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        .heatmap-legend-item {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        /* GARDEN VISUAL */
        .garden-visual {
            background: linear-gradient(to bottom, #e8f4f8 0%, #f5f9e8 100%);
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 16px var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .garden-visual::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to top, rgba(168, 184, 168, 0.2), transparent);
            pointer-events: none;
        }

        .garden-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--navy);
            margin-bottom: 2rem;
            font-weight: 500;
            text-align: center;
        }

        .garden-flowers {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            align-items: flex-end;
            min-height: 200px;
            position: relative;
            z-index: 1;
        }

        .flower {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            animation: flowerGrow 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .flower:hover {
            transform: translateY(-8px);
        }

        @keyframes flowerGrow {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .flower-bloom {
            width: 50px;
            height: 50px;
            position: relative;
            margin-bottom: 4px;
        }

        .flower-bloom.small { width: 35px; height: 35px; }
        .flower-bloom.medium { width: 50px; height: 50px; }
        .flower-bloom.large { width: 65px; height: 65px; }

        .flower-stem {
            width: 3px;
            background: linear-gradient(to bottom, #7fa87f, #a8b8a8);
            border-radius: 2px;
        }

        .flower-stem.small { height: 40px; }
        .flower-stem.medium { height: 60px; }
        .flower-stem.large { height: 80px; }

        .flower-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--navy);
            font-weight: 500;
            text-align: center;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .garden-stats {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(168, 184, 168, 0.3);
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        /* MUSIC PLAYER MODAL */
        .music-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(27, 43, 58, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .music-modal.active {
            display: flex;
        }

        .music-modal-content {
            background: linear-gradient(135deg, var(--cream) 0%, white 100%);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .music-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--whisper);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .music-modal-close:hover {
            background: var(--crimson);
            transform: rotate(90deg);
        }

        .music-modal-close:hover svg {
            stroke: white;
        }

        .music-modal-close svg {
            width: 24px;
            height: 24px;
        }

        .music-modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            color: var(--navy);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .music-modal-subtitle {
            font-size: 0.95rem;
            color: var(--text-soft);
            margin-bottom: 2.5rem;
            font-style: italic;
        }

        .music-player-card {
            background: var(--cream);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 16px var(--shadow);
            margin-bottom: 1.5rem;
        }

        .music-album-art {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--gold-pale) 0%, var(--rosy) 100%);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .music-album-art svg {
            width: 80px;
            height: 80px;
            fill: white;
            opacity: 0.3;
        }

        .music-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            animation: musicWave 2s ease-in-out infinite;
        }

        @keyframes musicWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .music-now-playing {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .music-track-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: var(--navy);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .music-track-artist {
            font-size: 0.9rem;
            color: var(--text-soft);
        }

        .music-controls-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .music-play-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-soft) 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(139, 38, 53, 0.3);
        }

        .music-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(139, 38, 53, 0.4);
        }

        .music-play-btn svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .music-volume-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
        }

        .music-volume-icon {
            width: 20px;
            height: 20px;
            fill: var(--text-soft);
            flex-shrink: 0;
        }

        .music-volume-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--whisper);
            border-radius: 3px;
            outline: none;
        }

        .music-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--crimson);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .music-volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--crimson);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .music-playlist {
            margin-top: 1.5rem;
        }

        .music-playlist-title {
            font-size: 0.9rem;
            color: var(--text-soft);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .music-track-item {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--cream);
        }

        .music-track-item:hover {
            background: var(--gold-pale);
            transform: translateX(4px);
        }

        .music-track-item.active {
            background: var(--gold-pale);
            border-left: 3px solid var(--crimson);
        }

        .music-track-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .music-track-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--crimson);
        }

        .music-track-info {
            flex: 1;
        }

        .music-track-info-name {
            font-size: 0.95rem;
            color: var(--navy);
            font-weight: 500;
        }

        .music-track-info-duration {
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        /* Music button in header */
        .header-music-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--whisper);
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .header-music-btn:hover {
            background: var(--gold-pale);
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .header-music-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--navy);
        }

        .header-music-btn.playing::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background: var(--crimson);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .affirmation {
                right: 1rem;
                max-width: 240px;
            }

            .header {
                padding: 1rem 1rem 0.75rem;
            }

            .logo-main {
                font-size: 1.4rem;
            }

            .logo-sub {
                font-size: 0.6rem;
                letter-spacing: 0.15em;
            }

            .signature {
                font-size: 1.5rem;
            }

            .main {
                padding: 2rem 1rem 3rem;
            }

            .heatmap-grid {
                gap: 3px;
            }

            .garden-flowers {
                gap: 1rem;
            }

            .flower-bloom.large { width: 50px; height: 50px; }

            .music-modal-close {
                width: 48px;
                height: 48px;
            }

            .music-modal-close svg {
                width: 28px;
                height: 28px;
            }
        }

            .nav {
                padding: 1rem;
            }

            .entrance-card {
                padding: 2rem 1.5rem;
            }

            .entrance-sentence {
                font-size: 1.75rem;
            }

            .word-grid {
                grid-template-columns: 1fr;
            }

            .data-actions {
                flex-direction: column;
                align-items: center;
            }

            .modal-content {
                padding: 2rem 1.5rem;
            }

            .tabs {
                overflow-x: auto;
            }

            .speaking-controls {
                flex-direction: column;
            }

            .category-grid {
                grid-template-columns: 1fr;
            }

            .pdf-save-btn {
                bottom: 1rem;
                left: 1rem;
                width: 48px;
                height: 48px;
            }

            .pdf-save-btn svg {
                width: 20px;
                height: 20px;
            }

            .transcript-btn {
                width: 36px;
                height: 36px;
            }

            .transcript-btn svg {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Animation Container for SVG effects -->
    <div class="animation-container" id="animationContainer"></div>

    <!-- Affirmation -->
    <div class="affirmation" id="affirmation">
        <div class="affirmation-text"></div>
        <div class="affirmation-translation"></div>
    </div>

    <!-- Heart Note -->
    <div class="heart-note" id="heart-note">
        <div id="heart-reason"></div>
        <div style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-soft);">
            C'est ton voyage.
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-main" id="logo-main" style="cursor: pointer;">Ma Maison</div>
                <div class="logo-sub" id="logo-sub" style="cursor: pointer;">OÃ¹ chaque moment est doux</div>
            </div>
            <div class="signature">apprendre</div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <button class="nav-link active" data-room="entree">L'EntrÃ©e</button>
        <button class="nav-link" data-room="jardin">Le Jardin</button>
        <button class="nav-link" data-room="lire">Le Coin Lecture</button>
        <button class="nav-link" data-room="ecouter">Le Studio d'Ã‰coute</button>
        <button class="nav-link" data-room="parler">Le Parloir</button>
        <button class="nav-link" data-room="ecrire">Le Salon d'Ã‰criture</button>
        <button class="nav-link" data-room="notes">Le Cabinet de Travail</button>
        <button class="nav-link" data-room="ressources">La RÃ©serve</button>
    </nav>

    <!-- Main -->
    <main class="main">
        <!-- L'EntrÃ©e -->
        <section class="room active" id="entree">
            <div class="room-intro">
                <h1 class="room-title">L'EntrÃ©e</h1>
                <p class="room-description">
                    Entre doucement. Prends ton temps. C'est ton espace, ton rythme.
                </p>
            </div>

            <div id="entrance-content"></div>

            <!-- Monthly Heatmap -->
            <div class="heatmap-container">
                <div class="heatmap-title">Ton activitÃ© d'Ã©tude</div>
                <div class="heatmap-grid" id="heatmap-grid"></div>
                <div class="heatmap-legend">
                    <span>Moins</span>
                    <div class="heatmap-legend-item" style="background: var(--whisper);"></div>
                    <div class="heatmap-legend-item" style="background: #fde8d0;"></div>
                    <div class="heatmap-legend-item" style="background: #f4be86;"></div>
                    <div class="heatmap-legend-item" style="background: #df7f29;"></div>
                    <div class="heatmap-legend-item" style="background: #b84d06;"></div>
                    <span>Plus</span>
                </div>
            </div>

            <!-- Study Timer -->
            <div class="entrance-card">
                <div class="entrance-sentence">Minuteur d'Ã©tude</div>
                <div class="entrance-translation">
                    Concentre-toi. Prends des pauses. Apprends Ã  ton rythme.
                </div>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <div id="timer-display" style="font-family: 'Cormorant Garamond', serif; font-size: 3rem; color: var(--navy); margin-bottom: 1rem; font-weight: 500;">25:00</div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary timer-preset" data-minutes="5">5 min</button>
                        <button class="btn btn-secondary timer-preset" data-minutes="15">15 min</button>
                        <button class="btn btn-secondary timer-preset active" data-minutes="25">25 min</button>
                        <button class="btn btn-secondary timer-preset" data-minutes="45">45 min</button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn btn-primary" id="timer-start">Commencer</button>
                        <button class="btn btn-secondary" id="timer-reset" style="display: none;">RÃ©initialiser</button>
                    </div>
                </div>
            </div>

            <!-- Data management -->
            <div class="entrance-card">
                <div class="entrance-sentence">Tes donnÃ©es</div>
                <div class="entrance-translation">
                    Tout reste sur ton appareil. Tu peux sauvegarder ou recommencer.
                </div>
                <div class="data-actions">
                    <button class="btn btn-secondary" id="export-data">
                        â¬‡ Exporter tout
                    </button>
                    <button class="btn btn-secondary" id="import-data">
                        â¬† Importer tout
                    </button>
                    <button class="btn-drive" id="drive-link" title="Sauvegarde Google Drive">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                    </button>
                    <button class="btn btn-danger" id="reset-data">
                        Recommencer Ã  zÃ©ro
                    </button>
                </div>
            </div>

            <!-- Account Section -->
            <div class="entrance-card">
                <div class="entrance-sentence">Ton compte</div>
                <div class="entrance-translation">
                    Connecte-toi pour sauvegarder tes progrÃ¨s dans le cloud.
                </div>
                
                <!-- Login Button (shows when not logged in) -->
                <div id="entrance-login-section" style="text-align: center; margin-top: 1.5rem;">
                    <button class="btn btn-primary" id="entrance-login-btn" onclick="openModal('auth-modal')" style="padding: 0.75rem 2rem; font-size: 1rem;">
                        Se connecter
                    </button>
                </div>
                
                <!-- User Profile (shows when logged in) -->
                <div id="entrance-user-profile" style="display: none; text-align: center; margin-top: 1.5rem;">
                    <div style="display: inline-flex; align-items: center; gap: 1rem; background: var(--cream-dark); padding: 1rem 1.5rem; border-radius: 24px; border: 1px solid var(--whisper);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-soft) 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 1.1rem;" id="entrance-user-avatar"></div>
                        <div style="text-align: left;">
                            <div style="font-weight: 500; color: var(--navy); margin-bottom: 0.25rem;">ConnectÃ©</div>
                            <div id="entrance-user-email" style="color: var(--text-soft); font-size: 0.9rem;"></div>
                        </div>
                        <button class="btn btn-secondary" id="entrance-logout-btn" style="margin-left: 1rem;">DÃ©connexion</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Le Jardin -->
        <section class="room" id="jardin">
            <div class="room-intro">
                <h1 class="room-title">Le Jardin</h1>
                <p class="room-description">
                    Plante des mots. Laisse-les grandir dans leur propre temps.
                </p>
            </div>

            <!-- Garden Visual -->
            <div class="garden-visual">
                <div class="garden-title">Ton jardin de mots</div>
                <div class="garden-flowers" id="garden-flowers"></div>
                <div class="garden-stats" id="garden-stats"></div>
            </div>

            <!-- Jardin Filters - NEW -->
            <div class="entrance-card" id="jardin-filters">
                <div class="entrance-sentence" style="font-size:1.5rem;">Explorer le jardin</div>

                <div class="category-grid">
                    <div>
                        <label class="form-label">AnnÃ©e</label>
                        <select class="form-select" id="filter-year">
                            <option value="">Toutes</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Trimestre</label>
                        <select class="form-select" id="filter-quarter">
                            <option value="">Tous</option>
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Semaine</label>
                        <select class="form-select" id="filter-week">
                            <option value="">Toutes</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">ThÃ¨me</label>
                        <select class="form-select" id="filter-theme">
                            <option value="">Tous les thÃ¨mes</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Favoris</label>
                        <select class="form-select" id="filter-favorite">
                            <option value="">Tous</option>
                            <option value="true">Favoris de Sasha â­</option>
                        </select>
                    </div>
                </div>

                <div style="text-align:right;">
                    <button class="btn btn-secondary" id="reset-filters">Tout afficher</button>
                </div>
            </div>

            <!-- Game section -->
            <div class="game-section">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary game-mode-btn" data-game="srs">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            SRS Review
                        </button>
                        <button class="btn btn-secondary game-mode-btn active" data-game="random">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <circle cx="15.5" cy="15.5" r="1.5"></circle>
                                <circle cx="8.5" cy="15.5" r="1.5"></circle>
                                <circle cx="15.5" cy="8.5" r="1.5"></circle>
                            </svg>
                            Mot alÃ©atoire
                        </button>
                        <button class="btn btn-secondary game-mode-btn" data-game="matching">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                                <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            Association
                        </button>
                        <button class="btn btn-secondary game-mode-btn" data-game="fillblank">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            ComplÃ©ter
                        </button>
                        <button class="btn btn-secondary game-mode-btn" data-game="speed">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                            Chrono
                        </button>
                        <button class="btn btn-secondary game-mode-btn" data-game="quiz">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Quiz
                        </button>
                    </div>
                </div>

                <!-- Random Word Game (Original) -->
                <div class="game-container" id="game-random" style="display: block;">
                    <button class="btn btn-primary" id="random-word">
                        Donne-moi un mot
                    </button>
                    <div class="game-result" id="game-result">
                        <div class="game-prompt">Clique pour commencer</div>
                    </div>
                </div>

                <!-- Matching Game -->
                <div class="game-container" id="game-matching" style="display: none;">
                    <div class="game-instructions">Associe les mots franÃ§ais avec leurs traductions</div>
                    <div id="matching-pairs" class="matching-grid"></div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn btn-primary" id="start-matching">Commencer</button>
                        <button class="btn btn-secondary" id="reset-matching" style="display: none;">Nouvelle partie</button>
                    </div>
                    <div id="matching-score" style="margin-top: 1rem; text-align: center; font-size: 1.2rem; color: var(--navy);"></div>
                </div>

                <!-- Fill in the Blank -->
                <div class="game-container" id="game-fillblank" style="display: none;">
                    <div class="game-instructions">ComplÃ¨te la phrase avec le bon mot</div>
                    <div id="fillblank-content">
                        <div id="fillblank-sentence" style="font-size: 1.3rem; color: var(--navy); margin: 2rem 0; font-family: 'Cormorant Garamond', serif;"></div>
                        <div id="fillblank-options" style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;"></div>
                        <div id="fillblank-feedback" style="margin-top: 1.5rem; font-size: 1.1rem; min-height: 40px;"></div>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn btn-primary" id="start-fillblank">Commencer</button>
                        <button class="btn btn-secondary" id="next-fillblank" style="display: none;">Suivant</button>
                    </div>
                    <div id="fillblank-score" style="margin-top: 1rem; text-align: center; font-size: 1rem; color: var(--text-soft);"></div>
                </div>

                <!-- Speed Round -->
                <div class="game-container" id="game-speed" style="display: none;">
                    <div class="game-instructions">Combien de mots peux-tu te rappeler en 60 secondes ?</div>
                    <div id="speed-timer" style="font-size: 3rem; color: var(--crimson); font-family: 'Cormorant Garamond', serif; text-align: center; margin: 1.5rem 0;">60</div>
                    <div id="speed-word" style="font-size: 2rem; color: var(--navy); font-family: 'Cormorant Garamond', serif; text-align: center; margin: 1.5rem 0; min-height: 60px;"></div>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-primary" id="speed-know" style="display: none;">âœ“ Je sais</button>
                        <button class="btn btn-secondary" id="speed-skip" style="display: none;">â†’ Passer</button>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-primary" id="start-speed">Commencer</button>
                    </div>
                    <div id="speed-score" style="margin-top: 1rem; text-align: center; font-size: 1.1rem; color: var(--navy);"></div>
                </div>

                <!-- Translation Quiz -->
                <div class="game-container" id="game-quiz" style="display: none;">
                    <div class="game-instructions">Traduis ce mot</div>
                    <div id="quiz-word" style="font-size: 2.5rem; color: var(--crimson); font-family: 'Cormorant Garamond', serif; text-align: center; margin: 2rem 0; min-height: 80px;"></div>
                    <div style="max-width: 400px; margin: 0 auto;">
                        <input type="text" id="quiz-input" class="form-input" placeholder="Ta rÃ©ponse..." style="text-align: center; font-size: 1.2rem; display: none;">
                    </div>
                    <div id="quiz-feedback" style="margin-top: 1.5rem; font-size: 1.1rem; text-align: center; min-height: 40px;"></div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="btn btn-primary" id="start-quiz">Commencer</button>
                        <button class="btn btn-primary" id="submit-quiz" style="display: none;">VÃ©rifier</button>
                        <button class="btn btn-secondary" id="next-quiz" style="display: none;">Suivant</button>
                    </div>
                    <div id="quiz-score" style="margin-top: 1rem; text-align: center; font-size: 1rem; color: var(--text-soft);"></div>
                </div>

                <!-- SRS Review -->
                <div class="game-container" id="game-srs" style="display: none;">
                    <div class="srs-stats-grid">
                        <div class="srs-stat-box">
                            <div class="srs-stat-number" id="srs-due-count">0</div>
                            <div class="srs-stat-label">Due Today</div>
                        </div>
                        <div class="srs-stat-box">
                            <div class="srs-stat-number" id="srs-new-count">0</div>
                            <div class="srs-stat-label">New</div>
                        </div>
                        <div class="srs-stat-box">
                            <div class="srs-stat-number" id="srs-learning-count">0</div>
                            <div class="srs-stat-label">Learning</div>
                        </div>
                        <div class="srs-stat-box">
                            <div class="srs-stat-number" id="srs-mastered-count">0</div>
                            <div class="srs-stat-label">Mastered</div>
                        </div>
                    </div>
                    <div id="srs-session-area">
                        <div style="text-align: center; padding: 2rem;">
                            <button class="btn btn-primary" id="start-srs-session" style="font-size: 1.1rem; padding: 1.25rem 3rem;">
                                Commencer la rÃ©vision
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 2rem; text-align: center;">
                <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary view-toggle active" data-view="grid">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Grille
                    </button>
                    <button class="btn btn-secondary view-toggle" data-view="cards">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                        </svg>
                        Cartes
                    </button>
                    <button class="btn btn-primary" id="add-word-btn">+ Planter un nouveau mot</button>
                </div>
            </div>

            <!-- Flip Cards View -->
            <div id="flip-cards-container" style="display: none;">
                <div class="flip-card-wrapper">
                    <div class="flip-card" id="flip-card">
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <div class="flip-card-word" id="flip-card-word">Cliquez pour commencer</div>
                                <div class="flip-card-hint">Cliquez pour voir la traduction</div>
                            </div>
                            <div class="flip-card-back">
                                <div class="flip-card-meaning" id="flip-card-meaning"></div>
                                <div class="flip-card-example" id="flip-card-example"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flip-card-controls">
                    <button class="btn btn-secondary" id="flip-prev">â† PrÃ©cÃ©dent</button>
                    <div class="flip-card-counter">
                        <span id="flip-current">0</span> / <span id="flip-total">0</span>
                    </div>
                    <button class="btn btn-secondary" id="flip-next">Suivant â†’</button>
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary" id="flip-shuffle">ðŸ”€ MÃ©langer</button>
                </div>
            </div>

            <div class="word-grid" id="word-grid"></div>

            <!-- Export/Import Buttons -->
            <button class="pdf-save-btn" id="save-words-pdf" title="Sauvegarder les mots en PDF" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.5h8v1H8v-1zm0-3h8v1H8v-1z"/>
                </svg>
            </button>
            <button class="pdf-save-btn" id="save-words-csv" title="Exporter en CSV (Anki/Quizlet)" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm8-10v2h2v-2h-2zm0 4v2h2v-2h-2zM8 14h2v2H8v-2zm0-4h2v2H8v-2z"/>
                </svg>
            </button>
            <button class="pdf-save-btn" id="bulk-import-btn" title="Importer plusieurs mots" style="display: none;">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                </svg>
            </button>
        </section>

        <!-- Lire -->
        <section class="room" id="lire">
            <div class="room-intro">
                <h1 class="room-title">Le Coin Lecture</h1>
                <p class="room-description">
                    Garde une trace de ce que tu lis ou veux lire.
                </p>
            </div>

            <div style="margin-bottom: 2rem; text-align: center;">
                <button class="btn btn-primary" id="add-reading-btn">+ Ajouter un article ou livre</button>
                <button class="btn btn-secondary" id="add-reading-transcript-btn">+ Ajouter une transcription</button>
            </div>

            <div class="resource-grid" id="reading-grid"></div>
            
            <!-- Transcripts Section -->
            <div id="reading-transcripts-section" style="margin-top: 3rem; display: none;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--navy); margin-bottom: 1.5rem;">Transcriptions</h3>
                <div id="reading-transcripts-container"></div>
            </div>
        </section>

        <!-- Ã‰couter -->
        <section class="room" id="ecouter">
            <div class="room-intro">
                <h1 class="room-title">Le Studio d'Ã‰coute</h1>
                <p class="room-description">
                    Chansons, vidÃ©os, films â€” tout ce que tu Ã©coutes pour apprendre.
                </p>
            </div>

            <div style="margin-bottom: 2rem; text-align: center;">
                <button class="btn btn-primary" id="add-listening-btn">+ Ajouter une chanson/vidÃ©o/film</button>
                <button class="btn btn-secondary" id="add-listening-transcript-btn">+ Ajouter une transcription</button>
            </div>

            <div class="resource-grid" id="listening-grid"></div>
            
            <!-- Transcripts Section -->
            <div id="listening-transcripts-section" style="margin-top: 3rem; display: none;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--navy); margin-bottom: 1.5rem;">Transcriptions</h3>
                <div id="listening-transcripts-container"></div>
            </div>
        </section>

        <!-- Parler -->
        <section class="room" id="parler">
            <div class="room-intro">
                <h1 class="room-title">Le Parloir</h1>
                <p class="room-description">
                    RÃ©ponds aux questions. Enregistre ta voix. Personne ne juge.
                </p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="practice">Pratiquer</button>
                <button class="tab" data-tab="recordings-tab">Enregistrements</button>
            </div>

            <!-- Practice tab -->
            <div class="tab-content active" id="practice">
                <!-- Question Input with Google Doc Link -->
                <div class="question-section">
                    <div class="question-header">
                        <h3 class="question-title">Question Ã  rÃ©pondre</h3>
                        <a href="https://docs.google.com/document/d/1VRRqrIv1ZbgeH5rBHolE_v-FRdrPXLIg9n7lz-DTX6g/edit?usp=drivesdk" target="_blank" class="doc-link">
                            <svg class="svg-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                            </svg>
                            <span>Voir les questions</span>
                        </a>
                    </div>
                    <input type="text" class="form-input question-input" id="parler-question" placeholder="Colle ou Ã©cris ta question ici...">
                </div>

                <!-- Recording Interface -->
                <div class="entrance-card">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn-speak" id="start-speaking">
                            <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                            Commencer Ã  parler
                        </button>
                        
                        <button class="btn-speak" onclick="document.getElementById('audio-upload-input').click()">
                            <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            TÃ©lÃ©charger un audio
                        </button>
                        <input type="file" id="audio-upload-input" accept="audio/*" style="display: none;">
                    </div>
                    
                    <div id="speaking-indicator" style="display: none; text-align: center; margin: 1rem 0; color: var(--crimson); font-weight: 500;">
                        <span style="display: inline-block; animation: pulse 1.5s ease-in-out infinite;">â— En Ã©coute...</span>
                    </div>
                    
                    <div id="spoken-text" style="min-height: 60px;"></div>
                    
                    <div class="speaking-controls" id="recording-controls" style="display: none;">
                        <input type="text" class="form-input" id="recording-note" placeholder="Ajoute une note supplÃ©mentaire (optionnel)...">
                        <button class="btn btn-secondary" id="save-recording">Sauvegarder</button>
                    </div>
                </div>
            </div>

            <!-- Recordings tab -->
            <div class="tab-content" id="recordings-tab">
                <!-- Stats Summary -->
                <div class="practice-stats" id="practice-stats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="total-recordings">0</div>
                        <div class="stat-label">Sessions totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="this-week-recordings">0</div>
                        <div class="stat-label">Cette semaine</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-words-spoken">0</div>
                        <div class="stat-label">Mots prononcÃ©s</div>
                    </div>
                </div>

                <div id="recordings-list"></div>
            </div>
        </section>

        <!-- Ã‰crire -->
        <section class="room" id="ecrire">
            <div class="room-intro">
                <h1 class="room-title">Le Salon d'Ã‰criture</h1>
                <p class="room-description">
                    Ã‰cris ce que tu veux. Tout est sauvegardÃ©.
                </p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="write">Ã‰crire</button>
                <button class="tab" data-tab="archive">Archive</button>
            </div>

            <!-- Write tab -->
            <div class="tab-content active" id="write">
                <div class="writing-container">
                    <textarea 
                        class="writing-area" 
                        id="writing-area"
                        placeholder="Commence Ã  Ã©crire..."></textarea>
                    
                    <div class="writing-footer">
                        <div class="word-count" id="word-count">0 mots</div>
                        <button class="btn btn-primary" id="save-writing">Sauvegarder</button>
                    </div>
                </div>
            </div>

            <!-- Archive tab -->
            <div class="tab-content" id="archive">
                <div id="writings-archive"></div>
            </div>
        </section>

        <!-- Notes -->
        <section class="room" id="notes">
            <div class="room-intro">
                <h1 class="room-title">Le Cabinet de Travail</h1>
                <p class="room-description">
                    Ta base de connaissances personnelle. Grammaire, prononciation, phrases â€” tout organisÃ©.
                </p>
            </div>

            <!-- Filters -->
            <div class="filter-bar">
                <button class="filter-tag active" data-note-filter="all">Tout</button>
                <button class="filter-tag" data-note-filter="grammaire">Grammaire</button>
                <button class="filter-tag" data-note-filter="prononciation">Prononciation</button>
                <button class="filter-tag" data-note-filter="phrases">Phrases</button>
                <button class="filter-tag" data-note-filter="vocabulaire">Vocabulaire</button>
                <button class="filter-tag" data-note-filter="culture">Culture</button>
                <button class="filter-tag" data-note-filter="autre">Autre</button>
            </div>

            <!-- Add Note Button -->
            <div style="margin-bottom: 2rem; text-align: center;">
                <button class="btn btn-primary" onclick="openModal('note-modal')">+ Ajouter une note</button>
            </div>

            <!-- Notes Grid -->
            <div id="notes-grid"></div>
        </section>

        <!-- Ressources -->
        <section class="room" id="ressources">
            <div class="room-intro">
                <h1 class="room-title">La RÃ©serve</h1>
                <p class="room-description">
                    Sites web, chaÃ®nes YouTube, applications â€” tous tes outils pour apprendre.
                </p>
            </div>

            <div style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap;">
                <div style="min-width: 200px;">
                    <select class="form-select" id="filter-resources-type">
                        <option value="">Tous les types</option>
                        <option value="website">Sites web</option>
                        <option value="youtube">YouTube</option>
                        <option value="app">Applications</option>
                        <option value="book">Livres</option>
                        <option value="podcast">Podcasts</option>
                        <option value="other">Autre</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="add-resource-btn">+ Ajouter une ressource</button>
            </div>

            <div class="resource-grid" id="resources-grid"></div>
        </section>
    </main>

    <!-- Word Modal -->
    <div class="modal" id="word-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Planter un mot</h2>
                <button class="close-btn" onclick="closeModal('word-modal')">&times;</button>
            </div>
            
            <form id="word-form">
                <div class="form-group">
                    <label class="form-label">Image (optionnel)</label>
                    <div class="image-upload-area" id="word-image-upload">
                        <p>Clique pour ajouter une image</p>
                        <img id="word-image-preview" class="image-preview" style="display: none;">
                    </div>
                    <input type="file" id="word-image-input" accept="image/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label class="form-label">Le mot en franÃ§ais</label>
                    <input type="text" class="form-input" id="word-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Signification / Meaning</label>
                    <input type="text" class="form-input" id="meaning-input" placeholder="What it means to you">
                </div>

                <div class="form-group">
                    <label class="form-label">Article (optionnel)</label>
                    <select class="form-select" id="article-input">
                        <option value="">â€”</option>
                        <option value="le">le (masculin)</option>
                        <option value="la">la (fÃ©minin)</option>
                        <option value="l'">l' (voyelle)</option>
                        <option value="les">les (pluriel)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Genre (optionnel)</label>
                    <select class="form-select" id="gender-input">
                        <option value="">â€”</option>
                        <option value="m">masculin</option>
                        <option value="f">fÃ©minin</option>
                    </select>
                </div>

                <div class="category-grid">
                    <div>
                        <label class="form-label">ThÃ¨me / Topic</label>
                        <input type="text" class="form-input" id="theme-input" placeholder="ex: amour, mode, cuisine..." list="theme-suggestions">
                        <datalist id="theme-suggestions">
                            <option value="amour">
                            <option value="mode">
                            <option value="nature">
                            <option value="nourriture">
                            <option value="voyage">
                            <option value="art">
                            <option value="musique">
                            <option value="Ã©motions">
                        </datalist>
                    </div>

                    <div>
                        <label class="form-label">Semaine / Week</label>
                        <select class="form-select" id="week-input">
                            <option value="">â€”</option>
                            <option value="1">Semaine 1</option>
                            <option value="2">Semaine 2</option>
                            <option value="3">Semaine 3</option>
                            <option value="4">Semaine 4</option>
                            <option value="5">Semaine 5</option>
                            <option value="6">Semaine 6</option>
                            <option value="7">Semaine 7</option>
                            <option value="8">Semaine 8</option>
                            <option value="9">Semaine 9</option>
                            <option value="10">Semaine 10</option>
                            <option value="11">Semaine 11</option>
                            <option value="12">Semaine 12</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Trimestre / Quarter</label>
                        <select class="form-select" id="quarter-input">
                            <option value="">â€”</option>
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">AnnÃ©e / Year</label>
                        <select class="form-select" id="year-input">
                            <option value="">â€”</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte neutre</label>
                    <input type="text" class="form-input" id="context1" placeholder="Une phrase simple avec ce mot">
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte Ã©motionnel (optionnel)</label>
                    <input type="text" class="form-input" id="context2" placeholder="Une phrase qui a du sens pour toi">
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte idiomatique (optionnel)</label>
                    <input type="text" class="form-input" id="context3" placeholder="Expression ou phrase naturelle">
                </div>

                <div class="form-group">
                    <label class="form-label">Note personnelle (optionnel)</label>
                    <textarea class="form-textarea" id="note-input" placeholder="Pourquoi ce mot t'intÃ©resse ? D'oÃ¹ vient-il ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('word-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Planter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Word Modal -->
    <div class="modal" id="edit-word-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier le mot</h2>
                <button class="close-btn" onclick="closeModal('edit-word-modal')">&times;</button>
            </div>
            
            <form id="edit-word-form">
                <input type="hidden" id="edit-word-id">
                
                <div class="form-group">
                    <label class="form-label">Image (optionnel)</label>
                    <div class="image-upload-area" id="edit-word-image-upload">
                        <p>Clique pour changer l'image</p>
                        <img id="edit-word-image-preview" class="image-preview" style="display: none;">
                    </div>
                    <input type="file" id="edit-word-image-input" accept="image/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label class="form-label">Le mot en franÃ§ais</label>
                    <input type="text" class="form-input" id="edit-word-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Signification / Meaning</label>
                    <input type="text" class="form-input" id="edit-meaning-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Article (optionnel)</label>
                    <select class="form-select" id="edit-article-input">
                        <option value="">â€”</option>
                        <option value="le">le (masculin)</option>
                        <option value="la">la (fÃ©minin)</option>
                        <option value="l'">l' (voyelle)</option>
                        <option value="les">les (pluriel)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Genre (optionnel)</label>
                    <select class="form-select" id="edit-gender-input">
                        <option value="">â€”</option>
                        <option value="m">masculin</option>
                        <option value="f">fÃ©minin</option>
                    </select>
                </div>

                <div class="category-grid">
                    <div>
                        <label class="form-label">ThÃ¨me / Topic</label>
                        <input type="text" class="form-input" id="edit-theme-input" list="theme-suggestions">
                    </div>

                    <div>
                        <label class="form-label">Semaine / Week</label>
                        <select class="form-select" id="edit-week-input">
                            <option value="">â€”</option>
                            <option value="1">Semaine 1</option>
                            <option value="2">Semaine 2</option>
                            <option value="3">Semaine 3</option>
                            <option value="4">Semaine 4</option>
                            <option value="5">Semaine 5</option>
                            <option value="6">Semaine 6</option>
                            <option value="7">Semaine 7</option>
                            <option value="8">Semaine 8</option>
                            <option value="9">Semaine 9</option>
                            <option value="10">Semaine 10</option>
                            <option value="11">Semaine 11</option>
                            <option value="12">Semaine 12</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">Trimestre / Quarter</label>
                        <select class="form-select" id="edit-quarter-input">
                            <option value="">â€”</option>
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label">AnnÃ©e / Year</label>
                        <select class="form-select" id="edit-year-input">
                            <option value="">â€”</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte neutre</label>
                    <input type="text" class="form-input" id="edit-context1">
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte Ã©motionnel (optionnel)</label>
                    <input type="text" class="form-input" id="edit-context2">
                </div>

                <div class="form-group">
                    <label class="form-label">Contexte idiomatique (optionnel)</label>
                    <input type="text" class="form-input" id="edit-context3">
                </div>

                <div class="form-group">
                    <label class="form-label">Note personnelle (optionnel)</label>
                    <textarea class="form-textarea" id="edit-note-input"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-word-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div class="modal" id="bulk-import-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Importer plusieurs mots</h2>
                <button class="close-btn" onclick="closeModal('bulk-import-modal')">&times;</button>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <p style="margin-bottom: 1rem; color: var(--text-soft);">
                    Colle tes mots dans le format suivant (une ligne par mot):
                </p>
                <div style="background: var(--cream-dark); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem; margin-bottom: 1rem;">
                    le chat | the cat | animaux<br>
                    la maison | the house | logement<br>
                    manger | to eat | verbes
                </div>
                <p style="color: var(--text-soft); font-size: 0.9rem;">
                    <strong>Format:</strong> mot franÃ§ais | signification | thÃ¨me (optionnel)<br>
                    SÃ©pare avec le symbole | (barre verticale)
                </p>
            </div>
            
            <form id="bulk-import-form">
                <div class="form-group">
                    <label class="form-label">Colle tes mots ici</label>
                    <textarea 
                        class="form-textarea" 
                        id="bulk-import-text" 
                        placeholder="le chat | the cat | animaux&#10;la maison | the house | logement&#10;manger | to eat | verbes"
                        rows="10"
                        required
                        style="font-family: monospace;"
                    ></textarea>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Semaine / Week (optionnel)</label>
                        <select class="form-select" id="bulk-week">
                            <option value="">â€”</option>
                            <option value="1">Semaine 1</option>
                            <option value="2">Semaine 2</option>
                            <option value="3">Semaine 3</option>
                            <option value="4">Semaine 4</option>
                            <option value="5">Semaine 5</option>
                            <option value="6">Semaine 6</option>
                            <option value="7">Semaine 7</option>
                            <option value="8">Semaine 8</option>
                            <option value="9">Semaine 9</option>
                            <option value="10">Semaine 10</option>
                            <option value="11">Semaine 11</option>
                            <option value="12">Semaine 12</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Trimestre / Quarter (optionnel)</label>
                        <select class="form-select" id="bulk-quarter">
                            <option value="">â€”</option>
                            <option value="Q1">Q1</option>
                            <option value="Q2">Q2</option>
                            <option value="Q3">Q3</option>
                            <option value="Q4">Q4</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">AnnÃ©e / Year (optionnel)</label>
                        <select class="form-select" id="bulk-year">
                            <option value="">â€”</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">ThÃ¨me par dÃ©faut (optionnel)</label>
                        <input type="text" class="form-input" id="bulk-theme" placeholder="ex: animaux">
                    </div>
                </div>

                <p style="color: var(--text-soft); font-size: 0.85rem; margin-bottom: 1.5rem;">
                    ðŸ’¡ Ces champs s'appliquent Ã  TOUS les mots importÃ©s. Si un mot a dÃ©jÃ  un thÃ¨me dans le fichier, il sera utilisÃ© Ã  la place.
                </p>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulk-import-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Importer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reading Modal -->
    <div class="modal" id="reading-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter Ã  ta bibliothÃ¨que</h2>
                <button class="close-btn" onclick="closeModal('reading-modal')">&times;</button>
            </div>
            
            <form id="reading-form">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="reading-type" required>
                        <option value="article">Article</option>
                        <option value="book">Livre</option>
                        <option value="blog">Blog</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="reading-title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel)</label>
                    <input type="url" class="form-input" id="reading-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="reading-status">
                        <option value="want">Je veux lire</option>
                        <option value="reading">En train de lire</option>
                        <option value="done">Lu</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="reading-note" placeholder="Pourquoi tu veux lire Ã§a ? Qu'est-ce que tu en penses ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reading-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Reading Modal -->
    <div class="modal" id="edit-reading-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier la lecture</h2>
                <button class="close-btn" onclick="closeModal('edit-reading-modal')">&times;</button>
            </div>
            
            <form id="edit-reading-form">
                <input type="hidden" id="edit-reading-id">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="edit-reading-type" required>
                        <option value="article">Article</option>
                        <option value="book">Livre</option>
                        <option value="blog">Blog</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="edit-reading-title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel)</label>
                    <input type="url" class="form-input" id="edit-reading-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="edit-reading-status">
                        <option value="want">Je veux lire</option>
                        <option value="reading">En train de lire</option>
                        <option value="done">Lu</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="edit-reading-note" placeholder="Pourquoi tu veux lire Ã§a ? Qu'est-ce que tu en penses ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-reading-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Listening Modal -->
    <div class="modal" id="listening-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter Ã  Ã©couter</h2>
                <button class="close-btn" onclick="closeModal('listening-modal')">&times;</button>
            </div>
            
            <form id="listening-form">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="listening-type" required>
                        <option value="song">Chanson</option>
                        <option value="video">VidÃ©o YouTube</option>
                        <option value="movie">Film</option>
                        <option value="series">SÃ©rie</option>
                        <option value="podcast">Podcast</option>
                        <option value="audio">Audio/MP3</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="listening-title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸŽµ Media URL (YouTube, MP3, etc.)</label>
                    <input type="url" class="form-input" id="listening-media-url" placeholder="https://youtube.com/watch?v=... ou .mp3">
                    <small style="color: var(--text-soft); font-size: 0.85rem;">Pour YouTube, copie l'URL complÃ¨te. Pour audio, utilise un lien direct .mp3 ou .wav</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien info/source (optionnel)</label>
                    <input type="url" class="form-input" id="listening-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸ“ Transcription liÃ©e (optionnel)</label>
                    <select class="form-select" id="listening-linked-transcript">
                        <option value="">Aucune transcription</option>
                    </select>
                    <small style="color: var(--text-soft); font-size: 0.85rem;">Lie une transcription existante ou crÃ©e-en une nouvelle aprÃ¨s</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="listening-note" placeholder="Qu'est-ce que tu apprends ? Expressions intÃ©ressantes ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('listening-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Listening Modal -->
    <div class="modal" id="edit-listening-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier l'Ã©coute</h2>
                <button class="close-btn" onclick="closeModal('edit-listening-modal')">&times;</button>
            </div>
            
            <form id="edit-listening-form">
                <input type="hidden" id="edit-listening-id">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="edit-listening-type" required>
                        <option value="song">Chanson</option>
                        <option value="video">VidÃ©o YouTube</option>
                        <option value="movie">Film</option>
                        <option value="series">SÃ©rie</option>
                        <option value="podcast">Podcast</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="edit-listening-title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel)</label>
                    <input type="url" class="form-input" id="edit-listening-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Lien paroles/transcription (optionnel)</label>
                    <input type="url" class="form-input" id="edit-listening-transcript" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="edit-listening-note" placeholder="Qu'est-ce que tu apprends ? Expressions intÃ©ressantes ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-listening-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resources Modal -->
    <div class="modal" id="resources-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter une ressource</h2>
                <button class="close-btn" onclick="closeModal('resources-modal')">&times;</button>
            </div>
            
            <form id="resources-form">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="resources-type" required>
                        <option value="website">Site Web</option>
                        <option value="youtube">ChaÃ®ne YouTube</option>
                        <option value="app">Application</option>
                        <option value="podcast">Podcast</option>
                        <option value="tool">Outil</option>
                        <option value="course">Cours</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Nom</label>
                    <input type="text" class="form-input" id="resources-name" required placeholder="Ex: Duolingo, French Today...">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="resources-description" placeholder="Ã€ quoi sert cette ressource ?">
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel mais recommandÃ©)</label>
                    <input type="url" class="form-input" id="resources-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes personnelles</label>
                    <textarea class="form-textarea" id="resources-note" placeholder="Pourquoi tu aimes cette ressource ? Comment tu l'utilises ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('resources-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Resources Modal -->
    <div class="modal" id="edit-resources-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier la ressource</h2>
                <button class="close-btn" onclick="closeModal('edit-resources-modal')">&times;</button>
            </div>
            
            <form id="edit-resources-form">
                <input type="hidden" id="edit-resources-id">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="edit-resources-type" required>
                        <option value="website">Site Web</option>
                        <option value="youtube">ChaÃ®ne YouTube</option>
                        <option value="app">Application</option>
                        <option value="podcast">Podcast</option>
                        <option value="tool">Outil</option>
                        <option value="course">Cours</option>
                        <option value="other">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Nom</label>
                    <input type="text" class="form-input" id="edit-resources-name" required placeholder="Ex: Duolingo, French Today...">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="edit-resources-description" placeholder="Ã€ quoi sert cette ressource ?">
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel mais recommandÃ©)</label>
                    <input type="url" class="form-input" id="edit-resources-link" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes personnelles</label>
                    <textarea class="form-textarea" id="edit-resources-note" placeholder="Pourquoi tu aimes cette ressource ? Comment tu l'utilises ?"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-resources-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter une note</h2>
                <button class="close-btn" onclick="closeModal('note-modal')">&times;</button>
            </div>
            
            <form id="note-form">
                <div class="form-group">
                    <label class="form-label">CatÃ©gorie</label>
                    <select class="form-select" id="note-category" required>
                        <option value="">Choisir...</option>
                        <option value="grammaire">Grammaire</option>
                        <option value="prononciation">Prononciation</option>
                        <option value="phrases">Phrases</option>
                        <option value="vocabulaire">Vocabulaire</option>
                        <option value="culture">Culture</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre / Question</label>
                    <input type="text" class="form-input" id="note-title" placeholder="ex: Comment utiliser le subjonctif ?" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Contenu / RÃ©ponse</label>
                    <textarea class="form-textarea" id="note-content" rows="6" placeholder="Ã‰cris ta note ici..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel)</label>
                    <input type="url" class="form-input" id="note-link" placeholder="https://...">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('note-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div class="modal" id="edit-note-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier la note</h2>
                <button class="close-btn" onclick="closeModal('edit-note-modal')">&times;</button>
            </div>
            
            <form id="edit-note-form">
                <input type="hidden" id="edit-note-id">
                <div class="form-group">
                    <label class="form-label">CatÃ©gorie</label>
                    <select class="form-select" id="edit-note-category" required>
                        <option value="">Choisir...</option>
                        <option value="grammaire">Grammaire</option>
                        <option value="prononciation">Prononciation</option>
                        <option value="phrases">Phrases</option>
                        <option value="vocabulaire">Vocabulaire</option>
                        <option value="culture">Culture</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Titre / Question</label>
                    <input type="text" class="form-input" id="edit-note-title" placeholder="ex: Comment utiliser le subjonctif ?" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Contenu / RÃ©ponse</label>
                    <textarea class="form-textarea" id="edit-note-content" rows="6" placeholder="Ã‰cris ta note ici..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Lien (optionnel)</label>
                    <input type="url" class="form-input" id="edit-note-link" placeholder="https://...">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-note-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Recording Modal -->
    <div class="modal" id="edit-recording-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier l'enregistrement</h2>
                <button class="close-btn" onclick="closeModal('edit-recording-modal')">&times;</button>
            </div>
            
            <form id="edit-recording-form">
                <input type="hidden" id="edit-recording-id">
                <div class="form-group">
                    <label class="form-label">Question</label>
                    <input type="text" class="form-input" id="edit-recording-question" placeholder="La question que tu as rÃ©pondu...">
                </div>

                <div class="form-group">
                    <label class="form-label">Note supplÃ©mentaire</label>
                    <textarea class="form-textarea" id="edit-recording-note" placeholder="Ajoute ou modifie ta note..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-recording-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Writing Modal -->
    <div class="modal" id="edit-writing-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier l'Ã©criture</h2>
                <button class="close-btn" onclick="closeModal('edit-writing-modal')">&times;</button>
            </div>
            
            <form id="edit-writing-form">
                <input type="hidden" id="edit-writing-id">
                <div class="form-group">
                    <label class="form-label">Texte</label>
                    <textarea class="form-textarea" id="edit-writing-text" rows="10" placeholder="Modifie ton texte ici..." required></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-writing-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <!-- Add Reading Transcript Modal -->
    <div class="modal" id="add-reading-transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter une transcription</h2>
                <button class="close-btn" onclick="closeModal('add-reading-transcript-modal')">&times;</button>
            </div>
            
            <form id="add-reading-transcript-form">
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="reading-transcript-title" placeholder="Ex: Article du Monde" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ðŸ“ Texte franÃ§ais</label>
                    <textarea class="form-textarea" id="reading-transcript-text" rows="8" placeholder="Colle le texte franÃ§ais ici..." required></textarea>
                </div>

                <div style="text-align: center; margin: 1rem 0;">
                    <button type="button" class="btn btn-secondary" id="translate-reading-btn" style="display: flex; align-items: center; gap: 0.5rem; margin: 0 auto;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8M10 14h4"></path>
                        </svg>
                        Traduire automatiquement
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸŒ Traduction anglaise (automatique)</label>
                    <textarea class="form-textarea" id="reading-transcript-translation" rows="8" placeholder="La traduction apparaÃ®tra ici..." readonly style="background: var(--cream-dark);"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸ”— Lier Ã  un matÃ©riel de lecture (optionnel)</label>
                    <select class="form-select" id="reading-transcript-linked-material">
                        <option value="">Aucun lien</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-reading-transcript-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Listening Transcript Modal -->
    <div class="modal" id="add-listening-transcript-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ajouter une transcription</h2>
                <button class="close-btn" onclick="closeModal('add-listening-transcript-modal')">&times;</button>
            </div>
            
            <form id="add-listening-transcript-form">
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="listening-transcript-title" placeholder="Ex: Paroles de chanson" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ðŸ“ Texte franÃ§ais (paroles/transcription)</label>
                    <textarea class="form-textarea" id="listening-transcript-text" rows="8" placeholder="Colle les paroles ici..." required></textarea>
                </div>

                <div style="text-align: center; margin: 1rem 0;">
                    <button type="button" class="btn btn-secondary" id="translate-listening-btn" style="display: flex; align-items: center; gap: 0.5rem; margin: 0 auto;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8M10 14h4"></path>
                        </svg>
                        Traduire automatiquement
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸŒ Traduction anglaise (automatique)</label>
                    <textarea class="form-textarea" id="listening-transcript-translation" rows="8" placeholder="La traduction apparaÃ®tra ici..." readonly style="background: var(--cream-dark);"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ðŸ”— Lier Ã  un matÃ©riel d'Ã©coute (optionnel)</label>
                    <select class="form-select" id="listening-transcript-linked-material">
                        <option value="">Aucun lien</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-listening-transcript-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Word Lookup Popup -->
    <div class="modal" id="word-lookup-modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="lookup-word-title">...</h2>
                <button class="close-btn" onclick="closeModal('word-lookup-modal')">&times;</button>
            </div>
            
            <div id="lookup-content" style="padding: 1.5rem;">
                <div style="text-align: center; padding: 2rem; color: var(--text-soft);">
                    Chargement...
                </div>
            </div>

            <div class="form-actions" id="lookup-actions" style="display: none;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('word-lookup-modal')">Annuler</button>
                <button type="button" class="btn btn-primary" id="save-lookup-word">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Floating Heart -->
    <svg class="floating-heart" width="80" height="80" viewBox="0 0 24 24" fill="#A64253">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
    </svg>

    <script>
        // ============================================
        // SVG ANIMATIONS
        // ============================================
        const animationContainer = document.getElementById('animationContainer');

        // SVG Definitions
        const heartSVG = `
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" 
                      fill="#ff6b8a" opacity="0.8"/>
            </svg>
        `;

        const musicNoteSVG = `
            <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" 
                      fill="#c9a861" opacity="0.7"/>
            </svg>
        `;

        function createFloatingHeart() {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.innerHTML = heartSVG;
            
            const randomX = Math.random() * window.innerWidth;
            const drift = (Math.random() - 0.5) * 200;
            const rotation = (Math.random() - 0.5) * 360;
            
            heart.style.left = randomX + 'px';
            heart.style.setProperty('--drift', drift + 'px');
            heart.style.setProperty('--rotation', rotation + 'deg');
            
            animationContainer.appendChild(heart);
            
            setTimeout(() => heart.remove(), 4000);
        }

        // Animation triggers
        let musicNoteInterval = null;

        // Create musical note (when music is playing)
        function createMusicalNote() {
            const note = document.createElement('div');
            note.className = 'musical-note';
            note.innerHTML = musicNoteSVG;
            
            const randomX = Math.random() * window.innerWidth;
            const rotation = (Math.random() - 0.5) * 720;
            
            note.style.left = randomX + 'px';
            note.style.bottom = '0px';
            note.style.setProperty('--rotation', rotation + 'deg');
            
            animationContainer.appendChild(note);
            
            setTimeout(() => note.remove(), 5000);
        }

        // Create firefly/ÑÐ²Ñ–Ñ‚Ð»ÑÑ‡Ð¾Ðº (dark mode only)
        // Start/stop music note animations
        function startMusicNoteAnimations() {
            if (musicNoteInterval) return;
            
            musicNoteInterval = setInterval(() => {
                createMusicalNote();
            }, 3000); // Every 3 seconds while music plays
        }

        function stopMusicNoteAnimations() {
            if (musicNoteInterval) {
                clearInterval(musicNoteInterval);
                musicNoteInterval = null;
            }
        }

        // Initialize animations on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check dark mode and start sparkles if appropriate
            if (document.body.classList.contains('dark-mode')) {
            }
        });

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        let vocabulary = JSON.parse(localStorage.getItem('vocabulary') || '[]');
        let writings = JSON.parse(localStorage.getItem('writings') || '[]');
        let readingList = JSON.parse(localStorage.getItem('readingList') || '[]');
        let listeningList = JSON.parse(localStorage.getItem('listeningList') || '[]');
        let recordings = JSON.parse(localStorage.getItem('recordings') || '[]');
        let resourcesList = JSON.parse(localStorage.getItem('resourcesList') || '[]');
        let notes = JSON.parse(localStorage.getItem('notes') || '[]');

        let currentRecording = null;

        // Easter egg click counters
        let logoSubClicks = 0;
        let logoMainClicks = 0;
        let logoSubTimer = null;
        let logoMainTimer = null;

        // === SRS SYSTEM ===
        function initializeSRSData() {
            vocabulary.forEach(word => {
                if (!word.srs) {
                    word.srs = {
                        easeFactor: 2.5,
                        interval: 0,
                        repetitions: 0,
                        dueDate: new Date().toISOString(),
                        lastReviewed: null,
                        status: 'new'
                    };
                }
            });
            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
        }

        function calculateNextReview(word, quality) {
            const srs = word.srs;
            srs.lastReviewed = new Date().toISOString();

            if (quality < 2) {
                srs.repetitions = 0;
                srs.interval = 1;
                srs.status = 'learning';
            } else {
                if (srs.repetitions === 0) {
                    srs.interval = 1;
                } else if (srs.repetitions === 1) {
                    srs.interval = 6;
                } else {
                    srs.interval = Math.round(srs.interval * srs.easeFactor);
                }
                srs.repetitions++;
                srs.easeFactor = srs.easeFactor + (0.1 - (3 - quality) * (0.08 + (3 - quality) * 0.02));
                if (srs.easeFactor < 1.3) srs.easeFactor = 1.3;
                if (quality === 3) srs.interval = Math.round(srs.interval * 1.3);
                if (srs.repetitions >= 3 && srs.interval >= 21) {
                    srs.status = 'mastered';
                } else {
                    srs.status = 'review';
                }
            }

            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + srs.interval);
            srs.dueDate = nextDate.toISOString();
        }

        function isDueForReview(word) {
            if (!word.srs) return true;
            return new Date(word.srs.dueDate) <= new Date();
        }

        function getDueWords() {
            return vocabulary.filter(w => isDueForReview(w));
        }

        function getSRSStats() {
            const dueWords = getDueWords();
            const newWords = vocabulary.filter(w => !w.srs || w.srs.status === 'new');
            const learningWords = vocabulary.filter(w => w.srs && w.srs.status === 'learning');
            const masteredWords = vocabulary.filter(w => w.srs && w.srs.status === 'mastered');
            return { 
                due: dueWords.length, 
                new: newWords.length, 
                learning: learningWords.length, 
                mastered: masteredWords.length 
            };
        }

        function updateSRSStatsDisplay() {
            const stats = getSRSStats();
            document.getElementById('srs-due-count').textContent = stats.due;
            document.getElementById('srs-new-count').textContent = stats.new;
            document.getElementById('srs-learning-count').textContent = stats.learning;
            document.getElementById('srs-mastered-count').textContent = stats.mastered;
        }

        let currentSRSSession = [];
        let currentSRSIndex = 0;

        function startSRSSession() {
            const dueWords = getDueWords();
            if (dueWords.length === 0) {
                showSRSComplete();
                return;
            }
            currentSRSSession = dueWords.sort(() => Math.random() - 0.5);
            currentSRSIndex = 0;
            showSRSCard(currentSRSSession[currentSRSIndex]);
        }

        function showSRSCard(word) {
            const sessionArea = document.getElementById('srs-session-area');
            sessionArea.innerHTML = `
                <div class="srs-progress-bar">
                    <div class="srs-progress-fill" style="width: ${(currentSRSIndex / currentSRSSession.length) * 100}%"></div>
                </div>
                <div class="srs-progress-text">${currentSRSIndex + 1} / ${currentSRSSession.length} cartes</div>
                <div class="srs-card-container" id="srs-card">
                    <div class="srs-card-word">${word.french}</div>
                    <button class="btn btn-primary" onclick="revealSRSAnswer()" style="margin: 1.5rem 0;">Voir la rÃ©ponse</button>
                    <div class="srs-card-translation">${word.english}</div>
                    ${word.example ? `<div class="srs-card-example">${word.example}</div>` : ''}
                    <div class="srs-difficulty-buttons">
                        <button class="srs-diff-btn again" onclick="rateSRSCard(0)">
                            <div>âŒ Ã€ revoir</div>
                            <small>< 1 jour</small>
                        </button>
                        <button class="srs-diff-btn hard" onclick="rateSRSCard(1)">
                            <div>ðŸ˜“ Difficile</div>
                            <small>< 6 jours</small>
                        </button>
                        <button class="srs-diff-btn good" onclick="rateSRSCard(2)">
                            <div>âœ… Bien</div>
                            <small>${getNextIntervalPreview(word, 2)} jours</small>
                        </button>
                        <button class="srs-diff-btn easy" onclick="rateSRSCard(3)">
                            <div>ðŸŒŸ Facile</div>
                            <small>${getNextIntervalPreview(word, 3)} jours</small>
                        </button>
                    </div>
                </div>
            `;
        }

        function getNextIntervalPreview(word, quality) {
            if (!word.srs) return 1;
            if (quality < 2) return 1;
            let interval;
            if (word.srs.repetitions === 0) {
                interval = 1;
            } else if (word.srs.repetitions === 1) {
                interval = 6;
            } else {
                interval = Math.round(word.srs.interval * word.srs.easeFactor);
            }
            if (quality === 3) interval = Math.round(interval * 1.3);
            return Math.max(1, interval);
        }

        function revealSRSAnswer() {
            document.getElementById('srs-card').classList.add('revealed');
            event.target.style.display = 'none';
        }

        function rateSRSCard(quality) {
            const word = currentSRSSession[currentSRSIndex];
            calculateNextReview(word, quality);
            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            
            // Trigger hearts for good/easy ratings
            if (quality >= 2) {
                createFloatingHeart();
            }
            
            currentSRSIndex++;
            if (currentSRSIndex >= currentSRSSession.length) {
                showSRSComplete();
            } else {
                showSRSCard(currentSRSSession[currentSRSIndex]);
            }
            updateSRSStatsDisplay();
        }

        function showSRSComplete() {
            const sessionArea = document.getElementById('srs-session-area');
            sessionArea.innerHTML = `
                <div class="srs-complete-message">
                    <div class="srs-complete-icon">ðŸŽ‰</div>
                    <div class="srs-complete-title">Bravo!</div>
                    <div class="srs-complete-subtitle">
                        Tu as terminÃ© ta session de rÃ©vision.<br>
                        Reviens demain pour continuer ton apprentissage!
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">Retour au jardin</button>
                </div>
            `;
            
            // Celebration hearts!
            for (let i = 0; i < 8; i++) {
                setTimeout(() => createFloatingHeart(), i * 200);
            }
        }

        // ============================================
        // FILTER STATE - NEW
        // ============================================
        let activeFilters = {
            year: "",
            quarter: "",
            week: "",
            theme: "",
            favorite: ""
        };

        // ============================================
        // IMPORT / EXPORT - FIXED
        // ============================================
        function setupImportExport() {
            console.log('setupImportExport called');
            const exportBtn = document.getElementById('export-data');
            const importBtn = document.getElementById('import-data');
            console.log('Export button:', exportBtn);
            console.log('Import button:', importBtn);
            
            if (!exportBtn || !importBtn) {
                console.error('BUTTONS NOT FOUND!');
                return;
            }
            
            document.getElementById('export-data').addEventListener('click', () => {
                console.log('Export clicked!');
                const data = {
                    vocabulary,
                    writings,
                    readingList,
                    listeningList,
                    recordings,
                    resourcesList,
                    notes,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ma-maison-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // FIX: Added missing import button click handler
            document.getElementById('import-data').addEventListener('click', () => {
                console.log('Import button clicked!');
                document.getElementById('import-file-input').click();
            });

            document.getElementById('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('Importer ces donnÃ©es ? Cela remplacera tout ce que tu as actuellement.')) {
                            vocabulary = data.vocabulary || [];
                            writings = data.writings || [];
                            readingList = data.readingList || [];
                            listeningList = data.listeningList || [];
                            recordings = data.recordings || [];
                            resourcesList = data.resourcesList || [];
                            notes = data.notes || [];
                            
                            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                            localStorage.setItem('writings', JSON.stringify(writings));
                            localStorage.setItem('readingList', JSON.stringify(readingList));
                            localStorage.setItem('listeningList', JSON.stringify(listeningList));
                            localStorage.setItem('recordings', JSON.stringify(recordings));
                            localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
                            localStorage.setItem('notes', JSON.stringify(notes));
                            
                            renderGarden();
                            populateJardinFilters(); // NEW
                            renderReadingList();
                            renderListeningList();
                            renderRecordings();
                            renderWritingsArchive();
                            renderResourcesList();
                            renderNotes();
                            
                            alert('DonnÃ©es importÃ©es avec succÃ¨s âœ“');
                        }
                    } catch (err) {
                        alert('Erreur : fichier invalide');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
                // Reset the file input
                e.target.value = '';
            });

            document.getElementById('drive-link').addEventListener('click', () => {
                window.open('https://drive.google.com/drive/folders/1E7JYANvw4DjaJ2VUsPZuuSExqB4PzU9f', '_blank');
            });

            document.getElementById('reset-data').addEventListener('click', () => {
                if (confirm('Vraiment tout effacer ? Cette action est irrÃ©versible.')) {
                if (confirm('DerniÃ¨re confirmation â€” tu es sÃ»r ?')) {
                    localStorage.clear();
                    vocabulary = [];
                    writings = [];
                    readingList = [];
                    listeningList = [];
                    recordings = [];
                    resourcesList = [];
                    activeFilters = { year: "", quarter: "", week: "", theme: "", favorite: "" };
                    renderGarden();
                    populateJardinFilters();
                    renderReadingList();
                    renderListeningList();
                    renderRecordings();
                    renderWritingsArchive();
                    renderResourcesList();
                    alert('Tout a Ã©tÃ© effacÃ©. Tu peux recommencer.');
                }
            }
            });
        }

        // ============================================
        // STUDY TIMER
        // ============================================
        let timerInterval = null;
        let timerSeconds = 25 * 60; // Default 25 minutes
        let timerRunning = false;

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function setupTimer() {
            const timerDisplay = document.getElementById('timer-display');
            const startBtn = document.getElementById('timer-start');
            const resetBtn = document.getElementById('timer-reset');
            const presetBtns = document.querySelectorAll('.timer-preset');

            if (!timerDisplay || !startBtn) return;

            // Preset buttons
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (timerRunning) return; // Don't change during countdown
                    
                    const minutes = parseInt(btn.dataset.minutes);
                    timerSeconds = minutes * 60;
                    updateTimerDisplay();
                    
                    // Update active state
                    presetBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Start/Pause button
            startBtn.addEventListener('click', () => {
                if (!timerRunning) {
                    // Start timer
                    timerRunning = true;
                    startBtn.textContent = 'Pause';
                    resetBtn.style.display = 'inline-block';
                    
                    timerInterval = setInterval(() => {
                        timerSeconds--;
                        updateTimerDisplay();
                        
                        if (timerSeconds <= 0) {
                            clearInterval(timerInterval);
                            timerRunning = false;
                            startBtn.textContent = 'Commencer';
                            
                            // Play sound or notification
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('Minuteur terminÃ© !', {
                                    body: 'Temps d\'Ã©tude terminÃ©. Prends une pause ! â˜•',
                                    icon: 'ðŸŽ‰'
                                });
                            } else {
                                alert('Temps d\'Ã©tude terminÃ© ! Prends une pause â˜•');
                            }
                        }
                    }, 1000);
                } else {
                    // Pause timer
                    timerRunning = false;
                    clearInterval(timerInterval);
                    startBtn.textContent = 'Reprendre';
                }
            });

            // Reset button
            resetBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                timerRunning = false;
                
                // Reset to active preset
                const activePreset = document.querySelector('.timer-preset.active');
                const minutes = activePreset ? parseInt(activePreset.dataset.minutes) : 25;
                timerSeconds = minutes * 60;
                
                updateTimerDisplay();
                startBtn.textContent = 'Commencer';
                resetBtn.style.display = 'none';
            });

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // ============================================
        // STUDY HEATMAP
        // ============================================
        function renderHeatmap() {
            const heatmapGrid = document.getElementById('heatmap-grid');
            if (!heatmapGrid) return;

            const today = new Date();
            const days = [];
            
            // Generate last 84 days (12 weeks)
            for (let i = 83; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                days.push(date);
            }

            heatmapGrid.innerHTML = days.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const count = getActivityCountForDate(dateStr);
                
                return `
                    <div class="heatmap-day" data-count="${Math.min(count, 10)}" data-date="${dateStr}">
                        <div class="heatmap-tooltip">
                            ${date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' })}: ${count} ${count === 1 ? 'mot' : 'mots'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActivityCountForDate(dateStr) {
            // Count words added on this date
            const wordsOnDate = vocabulary.filter(w => {
                if (!w.created) return false;
                const wordDate = new Date(w.created).toISOString().split('T')[0];
                return wordDate === dateStr;
            });
            return wordsOnDate.length;
        }

        // ============================================
        // GARDEN VISUAL
        // ============================================
        function renderGardenVisual() {
            const gardenFlowers = document.getElementById('garden-flowers');
            const gardenStats = document.getElementById('garden-stats');
            
            if (!gardenFlowers) return;

            const recentWords = [...vocabulary]
                .sort((a, b) => new Date(b.created) - new Date(a.created))
                .slice(0, 15); // Show last 15 words as flowers

            if (recentWords.length === 0) {
                gardenFlowers.innerHTML = `
                    <div style="text-align: center; color: var(--text-soft); padding: 2rem;">
                        Ton jardin est vide... Plante ton premier mot! ðŸŒ±
                    </div>
                `;
                gardenStats.innerHTML = '';
                return;
            }

            gardenFlowers.innerHTML = recentWords.map((word, index) => {
                const age = Math.floor((Date.now() - new Date(word.created)) / (1000 * 60 * 60 * 24));
                const size = age < 7 ? 'small' : age < 30 ? 'medium' : 'large';
                const colors = ['#ff6b8a', '#ffa07a', '#ffb347', '#f4d58d', '#d4a5d4', '#a8b8ff', '#8ab8d4'];
                const color = colors[index % colors.length];
                
                return `
                    <div class="flower" style="animation-delay: ${index * 0.1}s;">
                        <div class="flower-bloom ${size}">
                            <svg viewBox="0 0 100 100" width="100%" height="100%">
                                <!-- Center -->
                                <circle cx="50" cy="50" r="12" fill="#f4d58d"/>
                                <!-- Petals -->
                                <circle cx="50" cy="30" r="15" fill="${color}" opacity="0.9"/>
                                <circle cx="70" cy="40" r="15" fill="${color}" opacity="0.85"/>
                                <circle cx="70" cy="60" r="15" fill="${color}" opacity="0.8"/>
                                <circle cx="50" cy="70" r="15" fill="${color}" opacity="0.85"/>
                                <circle cx="30" cy="60" r="15" fill="${color}" opacity="0.8"/>
                                <circle cx="30" cy="40" r="15" fill="${color}" opacity="0.85"/>
                            </svg>
                        </div>
                        <div class="flower-stem ${size}"></div>
                        <div class="flower-label" title="${word.french}">${word.french}</div>
                    </div>
                `;
            }).join('');

            const totalWords = vocabulary.length;
            const thisWeek = vocabulary.filter(w => {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return new Date(w.created) >= weekAgo;
            }).length;

            gardenStats.innerHTML = `
                <strong>${totalWords}</strong> mots dans ton jardin Â· 
                <strong>${thisWeek}</strong> plantÃ©s cette semaine
            `;
        }

        // ============================================
        // FLOATING QUICK ACTIONS
        // ============================================
        function setupFloatingActions() {
            const floatingActions = document.getElementById('floating-actions');
            const mainBtn = document.getElementById('floating-main');
            const quickAddWord = document.getElementById('quick-add-word');
            const quickStartTimer = document.getElementById('quick-start-timer');
            const quickFlipCards = document.getElementById('quick-flip-cards');

            if (!floatingActions || !mainBtn) return;

            // Toggle menu
            mainBtn.addEventListener('click', () => {
                floatingActions.classList.toggle('active');
            });

            // Quick add word
            quickAddWord.addEventListener('click', () => {
                floatingActions.classList.remove('active');
                openModal('word-modal');
                // Navigate to jardin if not already there
                const jardinBtn = document.querySelector('[data-room="jardin"]');
                if (jardinBtn && !jardinBtn.classList.contains('active')) {
                    jardinBtn.click();
                }
            });

            // Quick start timer
            quickStartTimer.addEventListener('click', () => {
                floatingActions.classList.remove('active');
                // Navigate to entree
                const entreeBtn = document.querySelector('[data-room="entree"]');
                if (entreeBtn) {
                    entreeBtn.click();
                    // Scroll to timer
                    setTimeout(() => {
                        document.getElementById('timer-display')?.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 100);
                }
            });

            // Quick flip cards
            quickFlipCards.addEventListener('click', () => {
                floatingActions.classList.remove('active');
                // Navigate to jardin
                const jardinBtn = document.querySelector('[data-room="jardin"]');
                if (jardinBtn) {
                    jardinBtn.click();
                    // Switch to cards view
                    setTimeout(() => {
                        const cardsToggle = document.querySelector('[data-view="cards"]');
                        if (cardsToggle) {
                            cardsToggle.click();
                        }
                    }, 100);
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!floatingActions.contains(e.target) && floatingActions.classList.contains('active')) {
                    floatingActions.classList.remove('active');
                }
            });
        }

        // ============================================
        // FLIP CARDS
        // ============================================
        let flipCardsData = [];
        let currentFlipIndex = 0;

        function setupFlipCards() {
            const viewToggles = document.querySelectorAll('.view-toggle');
            const flipCardsContainer = document.getElementById('flip-cards-container');
            const wordGrid = document.getElementById('word-grid');
            const flipCard = document.getElementById('flip-card');
            const flipPrev = document.getElementById('flip-prev');
            const flipNext = document.getElementById('flip-next');
            const flipShuffle = document.getElementById('flip-shuffle');

            if (!viewToggles.length || !flipCardsContainer) return;

            // View toggle
            viewToggles.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    viewToggles.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    if (view === 'cards') {
                        flipCardsContainer.style.display = 'block';
                        wordGrid.style.display = 'none';
                        initializeFlipCards();
                    } else {
                        flipCardsContainer.style.display = 'none';
                        wordGrid.style.display = 'grid';
                    }
                });
            });

            // Flip card click
            flipCard.addEventListener('click', () => {
                flipCard.classList.toggle('flipped');
            });

            // Navigation
            flipPrev.addEventListener('click', () => {
                if (currentFlipIndex > 0) {
                    currentFlipIndex--;
                    showFlipCard(currentFlipIndex);
                }
            });

            flipNext.addEventListener('click', () => {
                if (currentFlipIndex < flipCardsData.length - 1) {
                    currentFlipIndex++;
                    showFlipCard(currentFlipIndex);
                }
            });

            // Shuffle
            flipShuffle.addEventListener('click', () => {
                flipCardsData = shuffleArray([...getFilteredVocabulary()]);
                currentFlipIndex = 0;
                showFlipCard(currentFlipIndex);
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (flipCardsContainer.style.display === 'block') {
                    if (e.key === 'ArrowLeft') {
                        flipPrev.click();
                    } else if (e.key === 'ArrowRight') {
                        flipNext.click();
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        flipCard.click();
                    }
                }
            });
        }

        function initializeFlipCards() {
            flipCardsData = getFilteredVocabulary();
            if (flipCardsData.length === 0) {
                document.getElementById('flip-card-word').textContent = 'Aucun mot disponible';
                document.getElementById('flip-card-meaning').textContent = '';
                document.getElementById('flip-card-example').textContent = '';
                document.getElementById('flip-current').textContent = '0';
                document.getElementById('flip-total').textContent = '0';
                return;
            }
            currentFlipIndex = 0;
            showFlipCard(currentFlipIndex);
        }

        function showFlipCard(index) {
            const card = flipCardsData[index];
            if (!card) return;

            // Reset flip state
            document.getElementById('flip-card').classList.remove('flipped');

            // Update content
            document.getElementById('flip-card-word').textContent = card.french;
            document.getElementById('flip-card-meaning').textContent = card.meaning || 'Pas de traduction';
            
            // Show best available context
            const context = card.contexts && card.contexts[0] ? card.contexts[0] : '';
            document.getElementById('flip-card-example').textContent = context;

            // Update counter
            document.getElementById('flip-current').textContent = index + 1;
            document.getElementById('flip-total').textContent = flipCardsData.length;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ============================================
        // AFFIRMATIONS
        // ============================================
        const affirmations = [
            { fr: "Tu es en train d'apprendre.", en: "You are learning." },
            { fr: "Chaque mot compte.", en: "Every word counts." },
            { fr: "C'est bien d'aller lentement.", en: "It's good to go slowly." },
            { fr: "Tu n'as rien Ã  prouver.", en: "You have nothing to prove." },
            { fr: "La langue t'appartient dÃ©jÃ .", en: "The language already belongs to you." },
            { fr: "ÃŠtre dÃ©butant, c'est courageux.", en: "Being a beginner is brave." },
            { fr: "Ce que tu fais compte.", en: "What you do matters." },
            { fr: "Tu es dÃ©jÃ  assez.", en: "You are already enough." },
            { fr: "La beautÃ© n'est pas une faiblesse.", en: "Beauty is not weakness." },
            { fr: "Tu apprends plus vite que tu crois.", en: "You learn faster than you think." },
            { fr: "Prends ton temps.", en: "Take your time." },
            { fr: "Tu es capable.", en: "You are capable." },
            { fr: "Courage !", en: "Courage!" },
            { fr: "Tu vas y arriver !", en: "You're going to make it!" },
            { fr: "Petit Ã  petit, l'oiseau fait son nid.", en: "Little by little, the bird builds its nest." },
            { fr: "Rome ne s'est pas faite en un jour.", en: "Rome wasn't built in a day." },
            { fr: "Continue comme Ã§a.", en: "Keep going like this." },
            { fr: "Tu fais des progrÃ¨s.", en: "You're making progress." },
            { fr: "Chaque erreur est une leÃ§on.", en: "Every mistake is a lesson." },
            { fr: "Sois fier de toi.", en: "Be proud of yourself." },
            { fr: "L'effort est dÃ©jÃ  une victoire.", en: "The effort is already a victory." },
            { fr: "Tu es plus fort que tu crois.", en: "You're stronger than you think." },
            { fr: "Rien n'est impossible.", en: "Nothing is impossible." },
            { fr: "Continue d'avancer.", en: "Keep moving forward." }
        ];

        function showAffirmation() {
            const affEl = document.getElementById('affirmation');
            const aff = affirmations[Math.floor(Math.random() * affirmations.length)];
            
            affEl.querySelector('.affirmation-text').textContent = aff.fr;
            affEl.querySelector('.affirmation-translation').textContent = aff.en;
            
            affEl.classList.add('visible');
            
            setTimeout(() => {
                affEl.classList.remove('visible');
            }, 8000);
        }

        setTimeout(() => {
            showAffirmation();
            setInterval(showAffirmation, 180000);
        }, 30000);

        // ============================================
        // SIGNATURE MAGIC - ONE RANDOM REASON
        // ============================================
        let apprendreClicks = 0;
        let apprendreTimeout;

        const poeticReasons = [
            "Pour vivre dans les rues de Paris",
            "Pour trouver l'amour au-delÃ  des frontiÃ¨res",
            "Pour Ãªtre libre dans ma propre peau",
            "Pour la beautÃ© des mots qui dansent",
            "Pour dÃ©fendre les droits humains, en franÃ§ais",
            "Pour Ã©couter le monde avec un nouvel cÅ“ur",
            "Pour devenir qui je suis vraiment",
            "Pour lire les poÃ¨mes dans leur langue natale",
            "Pour comprendre les chansons qui font pleurer",
            "Pour Ã©crire des lettres Ã  des inconnus",
            "Pour voyager sans Ãªtre touriste",
            "Pour rÃªver en couleurs diffÃ©rentes",
            "Pour construire une carriÃ¨re avec compassion",
            "Pour sentir le monde avec plus de nuances",
            "Pour la joie de comprendre un jeu de mots",
            "Pour parler Ã  des Ã©trangers comme des amis",
            "Pour lire les menus sans hÃ©sitation",
            "Pour le plaisir de l'accent qui roule",
            "Pour les conversations de minuit Ã  Paris",
            "Pour Ãªtre Ã  la fois chez soi et ailleurs"
        ];

        document.querySelector('.signature').addEventListener('click', function() {
            apprendreClicks++;
            
            // Clear previous timeout
            if (apprendreTimeout) clearTimeout(apprendreTimeout);
            
            // Set timeout to reset counter
            apprendreTimeout = setTimeout(() => {
                apprendreClicks = 0;
            }, 2000);
            
            // Show random reason on 3rd click
            if (apprendreClicks === 3) {
                this.style.color = '#D4A5A5';
                this.style.opacity = '0.9';
                this.style.transition = 'all 0.5s ease';
                
                // Show one random poetic reason
                showRandomHeartReason();
                apprendreClicks = 0;
                
                // Reset after 10 seconds
                setTimeout(() => {
                    this.style.color = 'var(--gold)';
                    this.style.opacity = '0.7';
                }, 10000);
            }
        });

        function showRandomHeartReason() {
            const randomReason = poeticReasons[Math.floor(Math.random() * poeticReasons.length)];
            const heartNote = document.getElementById('heart-note');
            const heartReason = document.getElementById('heart-reason');
            
            // Add heart icon
            heartReason.innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#D4A5A5" style="margin-bottom: 1rem;">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                <div style="font-family: 'Cormorant Garamond'; font-size: 1.3rem; color: var(--navy); line-height: 1.6;">
                    ${randomReason}
                </div>
            `;
            
            heartNote.style.display = 'block';
            
            // Add close functionality
            heartNote.onclick = function() {
                heartNote.style.opacity = '0';
                heartNote.style.transform = 'translate(-50%, -50%) scale(0.95)';
                heartNote.style.transition = 'all 0.5s ease';
                setTimeout(() => {
                    heartNote.style.display = 'none';
                    heartNote.style.opacity = '1';
                    heartNote.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 500);
            };
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (heartNote.style.display === 'block') {
                    heartNote.style.opacity = '0';
                    heartNote.style.transform = 'translate(-50%, -50%) scale(0.95)';
                    heartNote.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        heartNote.style.display = 'none';
                        heartNote.style.opacity = '1';
                        heartNote.style.transform = 'translate(-50%, -50%) scale(1)';
                    }, 500);
                }
            }, 8000);
        }

        // ============================================
        // DOUBLE-CLICK MAGIC ON ICONS âœ¨
        // ============================================
        document.addEventListener('dblclick', function(e) {
            const icon = e.target.closest('.empty-icon');
            if (icon) {
                const svg = icon.querySelector('svg');
                if (svg) {
                    // Turn gold with animation
                    svg.style.fill = '#C9A861';
                    svg.style.opacity = '1';
                    svg.style.transform = 'scale(1.2)';
                    svg.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    // Show affirmation
                    showAffirmation();
                    
                    // Gentle pulse then settle
                    setTimeout(() => {
                        svg.style.transform = 'scale(1.05)';
                    }, 400);
                    
                    setTimeout(() => {
                        svg.style.transform = 'scale(1)';
                    }, 700);
                }
            }
        });

        // ============================================
        // ENTRANCE PHRASES
        // ============================================
        const entrancePhrases = [
            {
                sentence: "Entre.",
                translation: "Come in.",
                note: "The imperative form of 'entrer' (to enter). A simple, direct welcome. Notice how French commands can be gentleâ€”they invite rather than order."
            },
            {
                sentence: "Prends ton temps.",
                translation: "Take your time.",
                note: "From 'prendre' (to take). This phrase embodies permission to slow down. The reflexive 'ton temps' (your time) makes it personal."
            },
            {
                sentence: "Reste ici.",
                translation: "Stay here.",
                note: "From 'rester' (to stay). An invitation to presence. 'Ici' (here) grounds you in the moment."
            }
        ];

        function renderEntrance() {
            const container = document.getElementById('entrance-content');
            container.innerHTML = entrancePhrases.map(p => `
                <div class="entrance-card">
                    <div class="entrance-sentence">${p.sentence}</div>
                    <div class="entrance-translation">${p.translation}</div>
                    <div class="entrance-note">${p.note}</div>
                </div>
            `).join('');
        }

        // ============================================
        // IMAGE HANDLING - FIXED
        // ============================================
        function setupImageUpload(uploadAreaId, inputId, previewId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);

            if (!uploadArea || !input || !preview) return;

            uploadArea.addEventListener('click', () => input.click());

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    alert('Veuillez sÃ©lectionner une image valide');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.onerror = () => {
                    alert('Erreur lors du chargement de l\'image');
                };
                reader.readAsDataURL(file);
            });
        }

        // ============================================
        // VOCABULARY GARDEN - UPDATED WITH FILTERS
        // ============================================
        function getFilteredVocabulary() {
            return vocabulary.filter(word => {
                if (activeFilters.year && word.year !== activeFilters.year) return false;
                if (activeFilters.quarter && word.quarter !== activeFilters.quarter) return false;
                if (activeFilters.week && word.week !== activeFilters.week) return false;
                if (activeFilters.theme && word.theme !== activeFilters.theme) return false;
                if (activeFilters.favorite === 'true' && !word.favorite) return false;
                return true;
            });
        }

        function renderGarden() {
            const grid = document.getElementById('word-grid');
            const filteredVocabulary = getFilteredVocabulary();
            
            if (filteredVocabulary.length === 0) {
                grid.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M12 22c4.97 0 9-4.03 9-9-4.97 0-9 4.03-9 9zM5.6 10.25c0 1.38 1.12 2.5 2.5 2.5.53 0 1.01-.16 1.42-.44l-.02.19c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5l-.02-.19c.4.28.89.44 1.42.44 1.38 0 2.5-1.12 2.5-2.5 0-1.25-.93-2.3-2.14-2.46.4-.49.64-1.1.64-1.79 0-1.38-1.12-2.5-2.5-2.5-.53 0-1.01.16-1.42.44l.02-.19C12.5 2.12 11.38 1 10 1S7.5 2.12 7.5 3.5l.02.19c-.4-.28-.89-.44-1.42-.44-1.38 0-2.5 1.12-2.5 2.5 0 .69.24 1.3.64 1.79-1.21.16-2.14 1.21-2.14 2.46z"/>
                            </svg>
                        </div>
                        <div class="empty-text">
                            ${vocabulary.length === 0 ? 'Rien ici encore...<br>Plante ton premier mot quand tu es prÃªt.' : 'Aucun mot ne correspond Ã  tes filtres.<br>Essaie avec des critÃ¨res diffÃ©rents.'}
                        </div>
                    </div>
                `;
                updatePDFButtonVisibility();
                return;
            }

            // Sort by most recent first
            const sortedVocabulary = [...filteredVocabulary].sort((a, b) => b.id - a.id);

            grid.innerHTML = sortedVocabulary.map(word => `
                <div class="word-card">
                    <div class="word-actions">
                        <button class="icon-btn ${word.favorite ? 'favorite-active' : ''}" onclick="toggleFavorite(${word.id})" title="${word.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                            <svg class="svg-icon" viewBox="0 0 24 24" fill="${word.favorite ? 'var(--gold)' : 'none'}" stroke="currentColor">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="editWord(${word.id})" title="Modifier">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="deleteWord(${word.id})" title="Supprimer">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                    ${word.image ? `<img src="${word.image}" class="word-image" alt="${word.french}">` : ''}
                    
                    <div class="category-tags">
                        ${word.favorite ? `<div class="category-tag" style="background: var(--gold-pale); color: var(--navy);">â­ Favori</div>` : ''}
                        ${word.theme ? `<div class="category-tag topic">${word.theme}</div>` : ''}
                        ${word.week ? `<div class="category-tag time">Semaine ${word.week}</div>` : ''}
                        ${word.quarter ? `<div class="category-tag time">${word.quarter}</div>` : ''}
                        ${word.year ? `<div class="category-tag time">${word.year}</div>` : ''}
                    </div>
                    
                    <div class="word-french">${word.french}</div>
                    ${word.meaning ? `<div class="word-meaning">${word.meaning}</div>` : ''}
                    ${word.article ? `<div class="word-article">${word.article}</div>` : ''}
                    
                    <div class="word-contexts">
                        ${word.contexts && word.contexts[0] ? `
                            <div class="context">
                                <div class="context-label">Neutre</div>
                                <div class="context-sentence">${word.contexts[0]}</div>
                            </div>
                        ` : ''}
                        ${word.contexts && word.contexts[1] ? `
                            <div class="context">
                                <div class="context-label">Ã‰motionnel</div>
                                <div class="context-sentence">${word.contexts[1]}</div>
                            </div>
                        ` : ''}
                        ${word.contexts && word.contexts[2] ? `
                            <div class="context">
                                <div class="context-label">Idiomatique</div>
                                <div class="context-sentence">${word.contexts[2]}</div>
                            </div>
                        ` : ''}
                    </div>
                    ${word.note ? `<div class="word-note">${word.note}</div>` : ''}
                </div>
            `).join('');
            
            updatePDFButtonVisibility();
            renderGardenVisual(); // Update garden visual when words change
            renderHeatmap(); // Update heatmap when words change
        }

        // ============================================
        // POPULATE JARDIN FILTERS - NEW
        // ============================================
        function populateJardinFilters() {
            const years = [...new Set(vocabulary.map(w => w.year).filter(Boolean))].sort();
            const weeks = [...new Set(vocabulary.map(w => w.week).filter(Boolean))].sort((a, b) => a - b);
            const themes = [...new Set(vocabulary.map(w => w.theme).filter(Boolean))].sort();

            const yearSelect = document.getElementById('filter-year');
            const weekSelect = document.getElementById('filter-week');
            const themeSelect = document.getElementById('filter-theme');

            // Year options
            yearSelect.innerHTML = '<option value="">Toutes</option>' +
                years.map(y => `<option value="${y}">${y}</option>`).join('');

            // Week options
            weekSelect.innerHTML = '<option value="">Toutes</option>' +
                weeks.map(w => `<option value="${w}">Semaine ${w}</option>`).join('');

            // Theme options
            themeSelect.innerHTML = '<option value="">Tous les thÃ¨mes</option>' +
                themes.map(t => `<option value="${t}">${t}</option>`).join('');

            // Set current filter values if they exist
            if (activeFilters.year) yearSelect.value = activeFilters.year;
            if (activeFilters.week) weekSelect.value = activeFilters.week;
            if (activeFilters.theme) themeSelect.value = activeFilters.theme;
            if (activeFilters.quarter) document.getElementById('filter-quarter').value = activeFilters.quarter;
        }

        // ============================================
        // FILTER EVENT LISTENERS - NEW
        // ============================================
        function setupFilterListeners() {
            document.getElementById('filter-year').addEventListener('change', e => {
                activeFilters.year = e.target.value;
                renderGarden();
            });

            document.getElementById('filter-quarter').addEventListener('change', e => {
                activeFilters.quarter = e.target.value;
                renderGarden();
            });

            document.getElementById('filter-week').addEventListener('change', e => {
                activeFilters.week = e.target.value;
                renderGarden();
            });

            document.getElementById('filter-theme').addEventListener('change', e => {
                activeFilters.theme = e.target.value;
                renderGarden();
            });

            document.getElementById('filter-favorite').addEventListener('change', e => {
                activeFilters.favorite = e.target.value;
                renderGarden();
            });

            document.getElementById('reset-filters').addEventListener('click', () => {
                activeFilters = { year: "", quarter: "", week: "", theme: "", favorite: "" };

                document.getElementById('filter-year').value = "";
                document.getElementById('filter-quarter').value = "";
                document.getElementById('filter-week').value = "";
                document.getElementById('filter-theme').value = "";
                document.getElementById('filter-favorite').value = "";

                renderGarden();
            });
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
            
            // AUTO-FILL FILTERS WHEN ADDING A WORD - NEW
            if (id === 'word-modal') {
                document.getElementById('year-input').value = activeFilters.year || "";
                document.getElementById('quarter-input').value = activeFilters.quarter || "";
                document.getElementById('week-input').value = activeFilters.week || "";
                document.getElementById('theme-input').value = activeFilters.theme || "";
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            const forms = ['word-form', 'edit-word-form', 'reading-form', 'listening-form', 'resources-form'];
            forms.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) form.reset();
            });
            
            // Reset image previews
            const previews = ['word-image-preview', 'edit-word-image-preview'];
            previews.forEach(previewId => {
                const preview = document.getElementById(previewId);
                if (preview) {
                    preview.style.display = 'none';
                    preview.src = '';
                }
            });
            
            // Reset file inputs
            const fileInputs = ['word-image-input', 'edit-word-image-input'];
            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) input.value = '';
            });
        }

        function editWord(id) {
            const word = vocabulary.find(w => w.id === id);
            if (!word) return;

            document.getElementById('edit-word-id').value = id;
            document.getElementById('edit-word-input').value = word.french;
            document.getElementById('edit-meaning-input').value = word.meaning || '';
            document.getElementById('edit-article-input').value = word.article || '';
            document.getElementById('edit-gender-input').value = word.gender || '';
            document.getElementById('edit-theme-input').value = word.theme || '';
            document.getElementById('edit-week-input').value = word.week || '';
            document.getElementById('edit-quarter-input').value = word.quarter || '';
            document.getElementById('edit-year-input').value = word.year || '';
            document.getElementById('edit-context1').value = word.contexts && word.contexts[0] ? word.contexts[0] : '';
            document.getElementById('edit-context2').value = word.contexts && word.contexts[1] ? word.contexts[1] : '';
            document.getElementById('edit-context3').value = word.contexts && word.contexts[2] ? word.contexts[2] : '';
            document.getElementById('edit-note-input').value = word.note || '';

            if (word.image) {
                const preview = document.getElementById('edit-word-image-preview');
                preview.src = word.image;
                preview.style.display = 'block';
            }

            openModal('edit-word-modal');
        }

        function deleteWord(id) {
            if (confirm('Supprimer ce mot ?')) {
                vocabulary = vocabulary.filter(w => w.id !== id);
                localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                
                // Sync to Firebase
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
                
                renderGarden();
                populateJardinFilters(); // Update filters after deletion
            }
        }

        function toggleFavorite(id) {
            const word = vocabulary.find(w => w.id === id);
            if (word) {
                word.favorite = !word.favorite;
                localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                
                // Sync to Firebase
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
                
                renderGarden();
            }
        }

        // ============================================
        // ADD WORD - FIXED
        // ============================================
        document.getElementById('word-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const imagePreview = document.getElementById('word-image-preview');
            
            const word = {
                id: Date.now(),
                french: document.getElementById('word-input').value.trim(),
                meaning: document.getElementById('meaning-input').value.trim() || '',
                article: document.getElementById('article-input').value,
                gender: document.getElementById('gender-input').value,
                theme: document.getElementById('theme-input').value.trim() || '',
                week: document.getElementById('week-input').value || '',
                quarter: document.getElementById('quarter-input').value || '',
                year: document.getElementById('year-input').value || '',
                contexts: [
                    document.getElementById('context1').value.trim(),
                    document.getElementById('context2').value.trim(),
                    document.getElementById('context3').value.trim()
                ].filter(Boolean),
                note: document.getElementById('note-input').value.trim() || '',
                image: imagePreview.style.display !== 'none' ? imagePreview.src : null,
                created: new Date().toISOString()
            };

            // Validate required field
            if (!word.french) {
                alert('Veuillez entrer un mot en franÃ§ais');
                return;
            }

            vocabulary.push(word);
            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            
            // Sync to Firebase
            if (window.syncToFirebase) {
                window.syncToFirebase();
            }
            
            renderGarden();
            populateJardinFilters(); // Update filters after adding
            closeModal('word-modal');
            
            // Trigger floating hearts animation
            for (let i = 0; i < 3; i++) {
                setTimeout(() => createFloatingHeart(), i * 300);
            }
        });

        // ============================================
        // EDIT WORD - FIXED
        // ============================================
        document.getElementById('edit-word-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-word-id').value);
            const index = vocabulary.findIndex(w => w.id === id);
            
            if (index === -1) return;

            const imagePreview = document.getElementById('edit-word-image-preview');

            vocabulary[index] = {
                ...vocabulary[index],
                french: document.getElementById('edit-word-input').value.trim(),
                meaning: document.getElementById('edit-meaning-input').value.trim() || '',
                article: document.getElementById('edit-article-input').value,
                gender: document.getElementById('edit-gender-input').value,
                theme: document.getElementById('edit-theme-input').value.trim() || '',
                week: document.getElementById('edit-week-input').value || '',
                quarter: document.getElementById('edit-quarter-input').value || '',
                year: document.getElementById('edit-year-input').value || '',
                contexts: [
                    document.getElementById('edit-context1').value.trim(),
                    document.getElementById('edit-context2').value.trim(),
                    document.getElementById('edit-context3').value.trim()
                ].filter(Boolean),
                note: document.getElementById('edit-note-input').value.trim() || '',
                image: imagePreview.style.display !== 'none' ? imagePreview.src : vocabulary[index].image
            };

            // Validate required field
            if (!vocabulary[index].french) {
                alert('Veuillez entrer un mot en franÃ§ais');
                return;
            }

            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            
            // Sync to Firebase
            if (window.syncToFirebase) {
                window.syncToFirebase();
            }
            
            renderGarden();
            populateJardinFilters(); // Update filters after editing
            closeModal('edit-word-modal');
        });

        // ============================================
        // RANDOM WORD GAME - UPDATED FOR FILTERS
        // ============================================
        document.getElementById('random-word').addEventListener('click', () => {
            const filteredVocabulary = getFilteredVocabulary();
            
            if (filteredVocabulary.length === 0) {
                document.getElementById('game-result').innerHTML = `
                    <div class="game-prompt">${vocabulary.length === 0 ? 'Plante quelques mots d\'abord' : 'Aucun mot ne correspond Ã  tes filtres'}</div>
                `;
                return;
            }

            const word = filteredVocabulary[Math.floor(Math.random() * filteredVocabulary.length)];
            const prompts = [
                "Utilise ce mot dans une phrase",
                "Dis-le Ã  voix haute",
                "Ã‰cris une Ã©motion avec ce mot",
                "Trouve un synonyme",
                "Conjugue ce verbe (ou invente une phrase)",
                "Dessine ce que ce mot signifie pour toi"
            ];
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];

            document.getElementById('game-result').innerHTML = `
                <div class="game-word">${word.french}</div>
                <div class="game-prompt">${prompt}</div>
            `;
        });

        // ============================================
        // GAME MODE SWITCHING
        // ============================================
        document.querySelectorAll('.game-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const gameMode = btn.dataset.game;
                
                // Update active button
                document.querySelectorAll('.game-mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Hide all game containers
                document.querySelectorAll('.game-container').forEach(c => c.style.display = 'none');
                
                // Show selected game
                document.getElementById(`game-${gameMode}`).style.display = 'block';
            });
        });

        // ============================================
        // MATCHING GAME
        // ============================================
        let matchingPairs = [];
        let selectedCards = [];
        let matchedCount = 0;

        document.getElementById('start-matching').addEventListener('click', startMatchingGame);
        document.getElementById('reset-matching').addEventListener('click', startMatchingGame);

        function startMatchingGame() {
            const filteredVocabulary = getFilteredVocabulary();
            if (filteredVocabulary.length < 4) {
                alert('Tu as besoin d\'au moins 4 mots pour jouer');
                return;
            }

            // Get 4 random words
            const shuffled = [...filteredVocabulary].sort(() => Math.random() - 0.5).slice(0, 4);
            matchingPairs = [];
            selectedCards = [];
            matchedCount = 0;

            // Create pairs
            shuffled.forEach((word, i) => {
                matchingPairs.push({ id: i, text: word.french, type: 'french', wordId: i });
                matchingPairs.push({ id: i + 4, text: word.meaning || word.french, type: 'meaning', wordId: i });
            });

            // Shuffle pairs
            matchingPairs.sort(() => Math.random() - 0.5);

            // Render
            const grid = document.getElementById('matching-pairs');
            grid.innerHTML = matchingPairs.map(pair => `
                <div class="matching-card" data-id="${pair.id}" data-word-id="${pair.wordId}">
                    ${pair.text}
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.matching-card').forEach(card => {
                card.addEventListener('click', handleMatchingClick);
            });

            document.getElementById('start-matching').style.display = 'none';
            document.getElementById('reset-matching').style.display = 'inline-block';
            document.getElementById('matching-score').textContent = '';
        }

        function handleMatchingClick(e) {
            const card = e.currentTarget;
            if (card.classList.contains('matched') || selectedCards.includes(card)) return;

            card.classList.add('selected');
            selectedCards.push(card);

            if (selectedCards.length === 2) {
                const [card1, card2] = selectedCards;
                const wordId1 = card1.dataset.wordId;
                const wordId2 = card2.dataset.wordId;

                if (wordId1 === wordId2) {
                    // Match!
                    card1.classList.remove('selected');
                    card2.classList.remove('selected');
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedCount++;

                    if (matchedCount === 4) {
                        setTimeout(() => {
                            document.getElementById('matching-score').innerHTML = 'âœ¨ Parfait ! Tu as tout trouvÃ© ! âœ¨';
                        }, 300);
                    }
                } else {
                    // No match
                    card1.classList.add('wrong');
                    card2.classList.add('wrong');
                    setTimeout(() => {
                        card1.classList.remove('selected', 'wrong');
                        card2.classList.remove('selected', 'wrong');
                    }, 600);
                }

                selectedCards = [];
            }
        }

        // ============================================
        // FILL IN THE BLANK GAME
        // ============================================
        let fillBlankScore = 0;
        let fillBlankTotal = 0;
        let currentFillBlankWord = null;

        document.getElementById('start-fillblank').addEventListener('click', nextFillBlank);
        document.getElementById('next-fillblank').addEventListener('click', nextFillBlank);

        function nextFillBlank() {
            const filteredVocabulary = getFilteredVocabulary();
            if (filteredVocabulary.length === 0) {
                alert('Aucun mot disponible');
                return;
            }

            // Get words with contexts
            const wordsWithContext = filteredVocabulary.filter(w => w.contexts && w.contexts[0]);
            if (wordsWithContext.length === 0) {
                alert('Tu as besoin de mots avec des exemples pour jouer');
                return;
            }

            currentFillBlankWord = wordsWithContext[Math.floor(Math.random() * wordsWithContext.length)];
            const sentence = currentFillBlankWord.contexts[0];

            // Replace the word with blank
            const blankSentence = sentence.replace(new RegExp(currentFillBlankWord.french, 'gi'), '______');

            // Get 3 wrong options
            const wrongOptions = filteredVocabulary
                .filter(w => w.id !== currentFillBlankWord.id)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(w => w.french);

            const allOptions = [currentFillBlankWord.french, ...wrongOptions].sort(() => Math.random() - 0.5);

            document.getElementById('fillblank-sentence').textContent = blankSentence;
            document.getElementById('fillblank-options').innerHTML = allOptions.map(opt => `
                <button class="fillblank-option" data-word="${opt}">${opt}</button>
            `).join('');

            document.querySelectorAll('.fillblank-option').forEach(btn => {
                btn.addEventListener('click', handleFillBlankChoice);
            });

            document.getElementById('fillblank-feedback').textContent = '';
            document.getElementById('start-fillblank').style.display = 'none';
            document.getElementById('next-fillblank').style.display = 'none';
            document.getElementById('fillblank-score').textContent = `Score: ${fillBlankScore}/${fillBlankTotal}`;
        }

        function handleFillBlankChoice(e) {
            const chosen = e.currentTarget.dataset.word;
            fillBlankTotal++;

            document.querySelectorAll('.fillblank-option').forEach(btn => {
                btn.style.pointerEvents = 'none';
            });

            if (chosen === currentFillBlankWord.french) {
                e.currentTarget.classList.add('correct');
                document.getElementById('fillblank-feedback').innerHTML = 'âœ“ Correct !';
                document.getElementById('fillblank-feedback').style.color = '#7fa87f';
                fillBlankScore++;
            } else {
                e.currentTarget.classList.add('incorrect');
                document.getElementById('fillblank-feedback').innerHTML = `âœ— C'Ã©tait: <strong>${currentFillBlankWord.french}</strong>`;
                document.getElementById('fillblank-feedback').style.color = 'var(--crimson)';
            }

            document.getElementById('next-fillblank').style.display = 'inline-block';
            document.getElementById('fillblank-score').textContent = `Score: ${fillBlankScore}/${fillBlankTotal}`;
        }

        // ============================================
        // SPEED ROUND GAME
        // ============================================
        let speedTimer = 60;
        let speedInterval = null;
        let speedCorrect = 0;
        let speedTotal = 0;
        let speedWords = [];
        let speedIndex = 0;

        document.getElementById('start-speed').addEventListener('click', startSpeedRound);
        document.getElementById('speed-know').addEventListener('click', () => handleSpeedAnswer(true));
        document.getElementById('speed-skip').addEventListener('click', () => handleSpeedAnswer(false));

        function startSpeedRound() {
            const filteredVocabulary = getFilteredVocabulary();
            if (filteredVocabulary.length === 0) {
                alert('Aucun mot disponible');
                return;
            }

            speedTimer = 60;
            speedCorrect = 0;
            speedTotal = 0;
            speedIndex = 0;
            speedWords = [...filteredVocabulary].sort(() => Math.random() - 0.5);

            document.getElementById('start-speed').style.display = 'none';
            document.getElementById('speed-know').style.display = 'inline-block';
            document.getElementById('speed-skip').style.display = 'inline-block';

            showSpeedWord();

            speedInterval = setInterval(() => {
                speedTimer--;
                document.getElementById('speed-timer').textContent = speedTimer;

                if (speedTimer <= 0) {
                    endSpeedRound();
                }
            }, 1000);
        }

        function showSpeedWord() {
            if (speedIndex >= speedWords.length) {
                speedWords = [...speedWords].sort(() => Math.random() - 0.5);
                speedIndex = 0;
            }
            document.getElementById('speed-word').textContent = speedWords[speedIndex].french;
        }

        function handleSpeedAnswer(correct) {
            speedTotal++;
            if (correct) speedCorrect++;
            speedIndex++;
            showSpeedWord();
        }

        function endSpeedRound() {
            clearInterval(speedInterval);
            document.getElementById('speed-know').style.display = 'none';
            document.getElementById('speed-skip').style.display = 'none';
            document.getElementById('start-speed').style.display = 'inline-block';
            document.getElementById('speed-word').textContent = '';
            document.getElementById('speed-timer').textContent = '60';
            document.getElementById('speed-score').innerHTML = `
                TerminÃ© ! ðŸŽ‰<br>
                Tu as reconnu <strong>${speedCorrect}</strong> mots sur <strong>${speedTotal}</strong>
            `;
        }

        // ============================================
        // TRANSLATION QUIZ GAME
        // ============================================
        let quizScore = 0;
        let quizTotal = 0;
        let currentQuizWord = null;

        document.getElementById('start-quiz').addEventListener('click', nextQuiz);
        document.getElementById('submit-quiz').addEventListener('click', checkQuizAnswer);
        document.getElementById('next-quiz').addEventListener('click', nextQuiz);

        document.getElementById('quiz-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkQuizAnswer();
            }
        });

        function nextQuiz() {
            const filteredVocabulary = getFilteredVocabulary();
            if (filteredVocabulary.length === 0) {
                alert('Aucun mot disponible');
                return;
            }

            currentQuizWord = filteredVocabulary[Math.floor(Math.random() * filteredVocabulary.length)];

            document.getElementById('quiz-word').textContent = currentQuizWord.french;
            document.getElementById('quiz-input').value = '';
            document.getElementById('quiz-input').style.display = 'block';
            document.getElementById('quiz-feedback').textContent = '';
            document.getElementById('start-quiz').style.display = 'none';
            document.getElementById('submit-quiz').style.display = 'inline-block';
            document.getElementById('next-quiz').style.display = 'none';
            document.getElementById('quiz-score').textContent = `Score: ${quizScore}/${quizTotal}`;
            document.getElementById('quiz-input').focus();
        }

        function checkQuizAnswer() {
            const answer = document.getElementById('quiz-input').value.trim().toLowerCase();
            const correct = (currentQuizWord.meaning || '').toLowerCase();

            quizTotal++;

            if (answer === correct || correct.includes(answer)) {
                document.getElementById('quiz-feedback').innerHTML = 'âœ“ Correct !';
                document.getElementById('quiz-feedback').style.color = '#7fa87f';
                quizScore++;
            } else {
                document.getElementById('quiz-feedback').innerHTML = `âœ— C'Ã©tait: <strong>${currentQuizWord.meaning}</strong>`;
                document.getElementById('quiz-feedback').style.color = 'var(--crimson)';
            }

            document.getElementById('submit-quiz').style.display = 'none';
            document.getElementById('next-quiz').style.display = 'inline-block';
            document.getElementById('quiz-score').textContent = `Score: ${quizScore}/${quizTotal}`;
        }

        // ============================================
        // READING LIST - FIXED WITH EDIT
        // ============================================
        function renderReadingList() {
            const grid = document.getElementById('reading-grid');
            
            if (readingList.length === 0) {
                grid.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/>
                            </svg>
                        </div>
                        <div class="empty-text">Rien ici encore...</div>
                    </div>
                `;
                return;
            }

            const statusLabels = {
                want: 'Je veux lire',
                reading: 'En train de lire',
                done: 'Lu'
            };

            // Sort by most recent first
            const sortedReadingList = [...readingList].sort((a, b) => b.id - a.id);

            grid.innerHTML = sortedReadingList.map(item => `
                <div class="resource-card">
                    <div class="resource-info">
                        <div class="resource-type">${item.type}</div>
                        <div class="resource-title">${item.title}</div>
                        ${item.link ? `<a href="${item.link}" class="resource-link" target="_blank" rel="noopener noreferrer">${item.link}</a>` : ''}
                        ${item.note ? `<div class="resource-note">${item.note}</div>` : ''}
                        <div class="resource-status">${statusLabels[item.status]}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="icon-btn" onclick="editReading(${item.id})" title="Modifier">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="deleteReading(${item.id})" title="Supprimer">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editReading(id) {
            const item = readingList.find(r => r.id === id);
            if (!item) return;

            document.getElementById('edit-reading-id').value = id;
            document.getElementById('edit-reading-type').value = item.type;
            document.getElementById('edit-reading-title').value = item.title;
            document.getElementById('edit-reading-link').value = item.link || '';
            document.getElementById('edit-reading-status').value = item.status;
            document.getElementById('edit-reading-note').value = item.note || '';

            openModal('edit-reading-modal');
        }

        function deleteReading(id) {
            if (confirm('Supprimer cet article ?')) {
                readingList = readingList.filter(r => r.id !== id);
                localStorage.setItem('readingList', JSON.stringify(readingList));
                renderReadingList();
            }
        }

        function setupReadingListeners() {
            document.getElementById('add-reading-btn').addEventListener('click', () => {
                openModal('reading-modal');
            });

            document.getElementById('reading-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                type: document.getElementById('reading-type').value,
                title: document.getElementById('reading-title').value.trim(),
                link: document.getElementById('reading-link').value.trim(),
                status: document.getElementById('reading-status').value,
                note: document.getElementById('reading-note').value.trim() || '',
                created: new Date().toISOString()
            };

            // Validate required field
            if (!item.title) {
                alert('Veuillez entrer un titre');
                return;
            }

            readingList.push(item);
            localStorage.setItem('readingList', JSON.stringify(readingList));
            renderReadingList();
            closeModal('reading-modal');
        });

        // EDIT READING FORM SUBMISSION
        document.getElementById('edit-reading-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-reading-id').value);
            const index = readingList.findIndex(r => r.id === id);
            
            if (index === -1) return;

            readingList[index] = {
                ...readingList[index],
                type: document.getElementById('edit-reading-type').value,
                title: document.getElementById('edit-reading-title').value.trim(),
                link: document.getElementById('edit-reading-link').value.trim(),
                status: document.getElementById('edit-reading-status').value,
                note: document.getElementById('edit-reading-note').value.trim() || ''
            };

            // Validate required field
            if (!readingList[index].title) {
                alert('Veuillez entrer un titre');
                return;
            }

            localStorage.setItem('readingList', JSON.stringify(readingList));
            renderReadingList();
            closeModal('edit-reading-modal');
        });
        }

        // ============================================
        // LISTENING LIST - FIXED WITH EDIT
        // ============================================
        function renderListeningList() {
            const grid = document.getElementById('listening-grid');
            
            if (listeningList.length === 0) {
                grid.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/>
                            </svg>
                        </div>
                        <div class="empty-text">Rien ici encore...</div>
                    </div>
                `;
                return;
            }

            // Sort by most recent first
            const sortedListeningList = [...listeningList].sort((a, b) => b.id - a.id);

            grid.innerHTML = sortedListeningList.map(item => `
                <div class="listening-card">
                    <div class="resource-info">
                        <div class="resource-type">${item.type}</div>
                        <div class="resource-title">${item.title}</div>
                        ${item.mediaUrl ? getEmbeddedPlayer(item.mediaUrl) : ''}
                        ${item.link ? `<a href="${item.link}" class="resource-link" target="_blank" rel="noopener noreferrer">${item.link}</a>` : ''}
                        ${item.note ? `<div class="resource-note">${item.note}</div>` : ''}
                        ${item.linkedTranscript ? `<div style="margin-top: 1rem;"><button class="btn btn-secondary" onclick="viewTranscript(${item.linkedTranscript}, 'listening')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">ðŸ“ Voir la transcription</button></div>` : ''}
                    </div>
                    <div class="resource-actions">
                        ${item.transcriptLink ? `
                            <a href="${item.transcriptLink}" class="transcript-btn" target="_blank" rel="noopener noreferrer" title="Voir les paroles/transcription">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                </svg>
                            </a>
                        ` : ''}
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="icon-btn" onclick="editListening(${item.id})" title="Modifier">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="icon-btn" onclick="deleteListening(${item.id})" title="Supprimer">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editListening(id) {
            const item = listeningList.find(l => l.id === id);
            if (!item) return;

            document.getElementById('edit-listening-id').value = id;
            document.getElementById('edit-listening-type').value = item.type;
            document.getElementById('edit-listening-title').value = item.title;
            document.getElementById('edit-listening-link').value = item.link || '';
            document.getElementById('edit-listening-transcript').value = item.transcriptLink || '';
            document.getElementById('edit-listening-note').value = item.note || '';

            openModal('edit-listening-modal');
        }

        function deleteListening(id) {
            if (confirm('Supprimer ce mÃ©dia ?')) {
                listeningList = listeningList.filter(l => l.id !== id);
                localStorage.setItem('listeningList', JSON.stringify(listeningList));
                renderListeningList();
            }
        }

        function setupListeningListeners() {
            document.getElementById('add-listening-btn').addEventListener('click', () => {
                openModal('listening-modal');
            });

            document.getElementById('listening-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                type: document.getElementById('listening-type').value,
                title: document.getElementById('listening-title').value.trim(),
                mediaUrl: document.getElementById('listening-media-url').value.trim(),
                link: document.getElementById('listening-link').value.trim(),
                transcriptLink: document.getElementById('listening-transcript')?.value.trim() || '',
                linkedTranscript: document.getElementById('listening-linked-transcript')?.value || '',
                note: document.getElementById('listening-note').value.trim() || '',
                created: new Date().toISOString()
            };

            // Validate required field
            if (!item.title) {
                alert('Veuillez entrer un titre');
                return;
            }

            listeningList.push(item);
            localStorage.setItem('listeningList', JSON.stringify(listeningList));
            renderListeningList();
            closeModal('listening-modal');
            
            document.getElementById('listening-form').reset();
        });

        // EDIT LISTENING FORM SUBMISSION
        document.getElementById('edit-listening-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-listening-id').value);
            const index = listeningList.findIndex(l => l.id === id);
            
            if (index === -1) return;

            listeningList[index] = {
                ...listeningList[index],
                type: document.getElementById('edit-listening-type').value,
                title: document.getElementById('edit-listening-title').value.trim(),
                link: document.getElementById('edit-listening-link').value.trim(),
                transcriptLink: document.getElementById('edit-listening-transcript').value.trim(),
                note: document.getElementById('edit-listening-note').value.trim() || ''
            };

            // Validate required field
            if (!listeningList[index].title) {
                alert('Veuillez entrer un titre');
                return;
            }

            localStorage.setItem('listeningList', JSON.stringify(listeningList));
            renderListeningList();
            closeModal('edit-listening-modal');
        });
        }

        // ============================================
        // RESOURCES LIST - FIXED WITH EDIT
        // ============================================
        function renderResourcesList() {
            const grid = document.getElementById('resources-grid');
            const filterType = document.getElementById('filter-resources-type')?.value || '';
            
            // Filter resources by type
            let filteredResources = resourcesList;
            if (filterType) {
                filteredResources = resourcesList.filter(r => r.type === filterType);
            }
            
            if (filteredResources.length === 0) {
                grid.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
                            </svg>
                        </div>
                        <div class="empty-text">${resourcesList.length === 0 ? 'Rien ici encore...' : 'Aucune ressource ne correspond Ã  ce filtre.'}</div>
                    </div>
                `;
                return;
            }

            const typeLabels = {
                website: 'Site Web',
                youtube: 'YouTube',
                app: 'Application',
                podcast: 'Podcast',
                book: 'Livre',
                tool: 'Outil',
                course: 'Cours',
                other: 'Autre'
            };

            // Sort by most recent first
            const sortedResourcesList = [...filteredResources].sort((a, b) => b.id - a.id);

            grid.innerHTML = sortedResourcesList.map(item => `
                <div class="resource-card">
                    <div class="resource-info">
                        <div class="resource-type">${typeLabels[item.type] || item.type}</div>
                        <div class="resource-title">${item.name}</div>
                        ${item.description ? `<div class="resource-note" style="margin-bottom: 0.5rem;">${item.description}</div>` : ''}
                        ${item.link ? `<a href="${item.link}" class="resource-link" target="_blank" rel="noopener noreferrer">${item.link}</a>` : ''}
                        ${item.note ? `<div class="resource-note">${item.note}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="icon-btn" onclick="editResource(${item.id})" title="Modifier">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="deleteResource(${item.id})" title="Supprimer">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editResource(id) {
            const item = resourcesList.find(r => r.id === id);
            if (!item) return;

            document.getElementById('edit-resources-id').value = id;
            document.getElementById('edit-resources-type').value = item.type;
            document.getElementById('edit-resources-name').value = item.name;
            document.getElementById('edit-resources-description').value = item.description || '';
            document.getElementById('edit-resources-link').value = item.link || '';
            document.getElementById('edit-resources-note').value = item.note || '';

            openModal('edit-resources-modal');
        }

        function deleteResource(id) {
            if (confirm('Supprimer cette ressource ?')) {
                resourcesList = resourcesList.filter(r => r.id !== id);
                localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
                renderResourcesList();
            }
        }

        function setupResourcesListeners() {
            document.getElementById('add-resource-btn').addEventListener('click', () => {
                openModal('resources-modal');
            });

            document.getElementById('resources-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                type: document.getElementById('resources-type').value,
                name: document.getElementById('resources-name').value.trim(),
                description: document.getElementById('resources-description').value.trim() || '',
                link: document.getElementById('resources-link').value.trim(),
                note: document.getElementById('resources-note').value.trim() || '',
                created: new Date().toISOString()
            };

            // Validate required field
            if (!item.name) {
                alert('Veuillez entrer un nom');
                return;
            }

            resourcesList.push(item);
            localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
            renderResourcesList();
            closeModal('resources-modal');
        });

        // EDIT RESOURCES FORM SUBMISSION
        document.getElementById('edit-resources-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-resources-id').value);
            const index = resourcesList.findIndex(r => r.id === id);
            
            if (index === -1) return;

            resourcesList[index] = {
                ...resourcesList[index],
                type: document.getElementById('edit-resources-type').value,
                name: document.getElementById('edit-resources-name').value.trim(),
                description: document.getElementById('edit-resources-description').value.trim() || '',
                link: document.getElementById('edit-resources-link').value.trim(),
                note: document.getElementById('edit-resources-note').value.trim() || ''
            };

            // Validate required field
            if (!resourcesList[index].name) {
                alert('Veuillez entrer un nom');
                return;
            }

            localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
            renderResourcesList();
            closeModal('edit-resources-modal');
        });
        }

        // ============================================
        // SPEAKING - FIXED VERSION
        // ============================================
        function initializeSpeechRecognition() {
            const startSpeakingBtn = document.getElementById('start-speaking');
            const spokenText = document.getElementById('spoken-text');
            const indicator = document.getElementById('speaking-indicator');
            const controls = document.getElementById('recording-controls');
            
            if (!startSpeakingBtn) return;
            
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            
            startSpeakingBtn.addEventListener('click', async function() {
                if (!isRecording) {
                    // Start recording
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        mediaRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = () => {
                                currentRecording = reader.result; // Base64 audio
                                spokenText.innerHTML = `
                                    <audio controls style="width: 100%; margin-top: 1rem;">
                                        <source src="${reader.result}" type="audio/webm">
                                    </audio>
                                `;
                                controls.style.display = 'flex';
                            };
                            
                            // Stop all tracks
                            stream.getTracks().forEach(track => track.stop());
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        startSpeakingBtn.textContent = 'ArrÃªter';
                        startSpeakingBtn.classList.add('btn-danger');
                        indicator.style.display = 'block';
                        spokenText.textContent = 'Enregistrement en cours...';
                        
                    } catch (error) {
                        spokenText.textContent = 'Erreur: Permission microphone refusÃ©e. Autorise-le dans les paramÃ¨tres du navigateur.';
                        console.error('Microphone error:', error);
                    }
                } else {
                    // Stop recording
                    mediaRecorder.stop();
                    isRecording = false;
                    startSpeakingBtn.innerHTML = `
                        <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        Commencer Ã  parler
                    `;
                    startSpeakingBtn.classList.remove('btn-danger');
                    indicator.style.display = 'none';
                }
            });
        }

        // Practice prompt selection
        document.getElementById('save-recording').addEventListener('click', () => {
            if (!currentRecording) {
                alert('Enregistre d\'abord un audio');
                return;
            }

            const question = document.getElementById('parler-question').value.trim();

            const recording = {
                id: Date.now(),
                question: question || 'Sans question',
                audioData: currentRecording, // Base64 audio
                note: document.getElementById('recording-note').value.trim() || '',
                created: new Date().toISOString()
            };

            recordings.push(recording);
            localStorage.setItem('recordings', JSON.stringify(recordings));
            
            // Clear UI
            document.getElementById('spoken-text').textContent = '';
            document.getElementById('recording-note').value = '';
            document.getElementById('parler-question').value = '';
            document.getElementById('recording-controls').style.display = 'none';
            currentRecording = null;

            renderRecordings();
            alert('SauvegardÃ© âœ“');
        });

        // Audio upload handler
        document.getElementById('audio-upload-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                currentRecording = event.target.result;
                const spokenText = document.getElementById('spoken-text');
                const controls = document.getElementById('recording-controls');
                
                spokenText.innerHTML = `
                    <audio controls style="width: 100%; margin-top: 1rem;">
                        <source src="${event.target.result}" type="${file.type}">
                    </audio>
                `;
                controls.style.display = 'flex';
            };
            reader.readAsDataURL(file);
            
            // Reset input
            e.target.value = '';
        });

        function renderRecordings() {
            const list = document.getElementById('recordings-list');
            const statsDiv = document.getElementById('practice-stats');
            
            if (recordings.length === 0) {
                statsDiv.style.display = 'none';
                list.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                            </svg>
                        </div>
                        <div class="empty-text">Rien ici encore...</div>
                    </div>
                `;
                return;
            }

            // Show stats
            statsDiv.style.display = 'grid';
            
            // Calculate stats
            const totalRecordings = recordings.length;
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const thisWeekRecordings = recordings.filter(r => new Date(r.created) >= oneWeekAgo).length;
            
            document.getElementById('total-recordings').textContent = totalRecordings;
            document.getElementById('this-week-recordings').textContent = thisWeekRecordings;
            document.getElementById('total-words-spoken').textContent = 'N/A';

            // Sort by most recent first
            const sortedRecordings = [...recordings].sort((a, b) => b.id - a.id);

            list.innerHTML = sortedRecordings.map(rec => {
                const date = new Date(rec.created);
                const dateStr = date.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="recording-card">
                        <div class="recording-header">
                            <div>
                                <div class="recording-date">${dateStr} Ã  ${timeStr}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="icon-btn" onclick="editRecording(${rec.id})" title="Modifier">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <button class="icon-btn" onclick="deleteRecording(${rec.id})" title="Supprimer">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        ${rec.question ? `<div style="font-weight: 500; color: var(--crimson); margin-bottom: 0.75rem; font-size: 1rem;">Q: ${rec.question}</div>` : ''}
                        ${rec.audioData ? `
                            <audio controls style="width: 100%; margin: 1rem 0;">
                                <source src="${rec.audioData}" type="audio/webm">
                            </audio>
                        ` : ''}
                        ${rec.note ? `<div class="recording-note">${rec.note}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function editRecording(id) {
            const rec = recordings.find(r => r.id === id);
            if (!rec) return;

            document.getElementById('edit-recording-id').value = id;
            document.getElementById('edit-recording-question').value = rec.question || '';
            document.getElementById('edit-recording-note').value = rec.note || '';

            openModal('edit-recording-modal');
        }

        // EDIT RECORDING FORM SUBMISSION
        document.getElementById('edit-recording-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-recording-id').value);
            const index = recordings.findIndex(r => r.id === id);
            
            if (index === -1) return;

            recordings[index] = {
                ...recordings[index],
                question: document.getElementById('edit-recording-question').value.trim(),
                note: document.getElementById('edit-recording-note').value.trim() || ''
            };

            localStorage.setItem('recordings', JSON.stringify(recordings));
            renderRecordings();
            closeModal('edit-recording-modal');
        });

        function deleteRecording(id) {
            if (confirm('Supprimer cet enregistrement ?')) {
                recordings = recordings.filter(r => r.id !== id);
                localStorage.setItem('recordings', JSON.stringify(recordings));
                renderRecordings();
            }
        }

        // ============================================
        // WRITING - FIXED WITH EDIT
        // ============================================
        const writingArea = document.getElementById('writing-area');
        const wordCountEl = document.getElementById('word-count');

        writingArea.addEventListener('input', () => {
            const text = writingArea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCountEl.textContent = `${words} mot${words !== 1 ? 's' : ''}`;
        });

        document.getElementById('save-writing').addEventListener('click', () => {
            const text = writingArea.value.trim();
            if (!text) {
                alert('Ã‰cris quelque chose d\'abord');
                return;
            }

            const writing = {
                id: Date.now(),
                text: text,
                created: new Date().toISOString()
            };

            writings.push(writing);
            localStorage.setItem('writings', JSON.stringify(writings));

            writingArea.value = '';
            wordCountEl.textContent = '0 mots';
            
            renderWritingsArchive();
            alert('SauvegardÃ© âœ“');
        });

        function renderWritingsArchive() {
            const archive = document.getElementById('writings-archive');
            
            if (writings.length === 0) {
                archive.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </div>
                        <div class="empty-text">Rien ici encore...</div>
                    </div>
                `;
                return;
            }

            // Sort by most recent first
            const sortedWritings = [...writings].sort((a, b) => b.id - a.id);

            archive.innerHTML = sortedWritings.map(writing => `
                <div class="writing-card">
                    <div class="writing-header">
                        <div class="writing-date">${new Date(writing.created).toLocaleDateString('fr-FR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="icon-btn" onclick="editWriting(${writing.id})" title="Modifier">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="icon-btn" onclick="deleteWriting(${writing.id})" title="Supprimer">
                                <svg class="svg-icon" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="writing-text">${writing.text.replace(/\n/g, '<br>')}</div>
                </div>
            `).join('');
        }

        function editWriting(id) {
            const writing = writings.find(w => w.id === id);
            if (!writing) return;

            document.getElementById('edit-writing-id').value = id;
            document.getElementById('edit-writing-text').value = writing.text;

            openModal('edit-writing-modal');
        }

        // EDIT WRITING FORM SUBMISSION
        document.getElementById('edit-writing-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-writing-id').value);
            const index = writings.findIndex(w => w.id === id);
            
            if (index === -1) return;

            writings[index] = {
                ...writings[index],
                text: document.getElementById('edit-writing-text').value.trim()
            };

            // Validate required field
            if (!writings[index].text) {
                alert('Veuillez entrer un texte');
                return;
            }

            localStorage.setItem('writings', JSON.stringify(writings));
            renderWritingsArchive();
            closeModal('edit-writing-modal');
        });

        function deleteWriting(id) {
            if (confirm('Supprimer cette Ã©criture ?')) {
                writings = writings.filter(w => w.id !== id);
                localStorage.setItem('writings', JSON.stringify(writings));
                renderWritingsArchive();
            }
        }

        // ============================================
        // TABS
        // ============================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const parent = tab.closest('section');
                const targetId = tab.dataset.tab;
                
                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                parent.querySelector(`#${targetId}`).classList.add('active');
            });
        });

        // ============================================
        // PDF EXPORT FOR WORDS
        // ============================================
        function saveWordsAsPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('Erreur : bibliothÃ¨que PDF non chargÃ©e');
                return;
            }
            
            const doc = new jsPDF();
            
            // Helper function to convert text to Latin1 compatible format
            function cleanText(text) {
                if (!text) return '';
                // Replace common French characters with their closest ASCII equivalents
                const map = {
                    'Ã ': 'a', 'Ã¢': 'a', 'Ã¡': 'a', 'Ã¤': 'a',
                    'Ã©': 'e', 'Ã¨': 'e', 'Ãª': 'e', 'Ã«': 'e',
                    'Ã®': 'i', 'Ã¯': 'i', 'Ã¬': 'i', 'Ã­': 'i',
                    'Ã´': 'o', 'Ã¶': 'o', 'Ã²': 'o', 'Ã³': 'o',
                    'Ã»': 'u', 'Ã¹': 'u', 'Ã¼': 'u', 'Ãº': 'u',
                    'Ã§': 'c', 'Ã±': 'n',
                    'Ã€': 'A', 'Ã‚': 'A', 'Ã': 'A', 'Ã„': 'A',
                    'Ã‰': 'E', 'Ãˆ': 'E', 'ÃŠ': 'E', 'Ã‹': 'E',
                    'ÃŽ': 'I', 'Ã': 'I', 'ÃŒ': 'I', 'Ã': 'I',
                    'Ã”': 'O', 'Ã–': 'O', 'Ã’': 'O', 'Ã“': 'O',
                    'Ã›': 'U', 'Ã™': 'U', 'Ãœ': 'U', 'Ãš': 'U',
                    'Ã‡': 'C', 'Ã‘': 'N'
                };
                return text.split('').map(char => map[char] || char).join('');
            }
            
            // Title
            doc.setFontSize(22);
            doc.setTextColor(139, 38, 53); // crimson
            doc.text(cleanText('Mon Vocabulaire FranÃ§ais'), 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(107, 97, 92); // text-soft
            const filterText = Object.values(activeFilters).filter(Boolean).length > 0 
                ? cleanText(`Filtres actifs: ${Object.entries(activeFilters).filter(([k,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ')}`)
                : '';
            doc.text(cleanText(`Genere le ${new Date().toLocaleDateString('fr-FR')} ${filterText}`), 20, 28);
            
            let y = 40;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            
            // Sort by most recent first
            const filteredVocabulary = getFilteredVocabulary();
            const sortedVocabulary = [...filteredVocabulary].sort((a, b) => b.id - a.id);
            
            sortedVocabulary.forEach((word, index) => {
                // Check if we need a new page
                if (y > pageHeight - 40) {
                    doc.addPage();
                    y = 20;
                }
                
                // Word number and French word
                doc.setFontSize(14);
                doc.setTextColor(27, 43, 58); // navy
                const wordText = word.article ? `${index + 1}. ${cleanText(word.article)} ${cleanText(word.french)}` : `${index + 1}. ${cleanText(word.french)}`;
                doc.text(wordText, margin, y);
                y += 7;
                
                // Meaning - THE IMPORTANT PART
                if (word.meaning) {
                    doc.setFontSize(11);
                    doc.setTextColor(42, 37, 32); // text
                    const meaningText = doc.splitTextToSize(cleanText(`-> ${word.meaning}`), 170);
                    doc.text(meaningText, margin + 5, y);
                    y += meaningText.length * 5;
                }
                
                // Categories on same line
                const categories = [];
                if (word.theme) categories.push(cleanText(word.theme));
                if (word.week) categories.push(`S${word.week}`);
                if (word.quarter) categories.push(cleanText(word.quarter));
                if (word.year) categories.push(word.year);
                
                if (categories.length > 0) {
                    doc.setFontSize(8);
                    doc.setTextColor(107, 97, 92);
                    doc.text(categories.join(' - '), margin + 5, y);
                    y += 5;
                }
                
                // Contexts
                if (word.contexts && word.contexts.length > 0) {
                    doc.setFontSize(9);
                    doc.setTextColor(107, 97, 92);
                    
                    if (word.contexts[0]) {
                        const contextText = doc.splitTextToSize(cleanText(`Ex: ${word.contexts[0]}`), 170);
                        doc.text(contextText, margin + 5, y);
                        y += contextText.length * 4;
                    }
                    
                    if (word.contexts[1]) {
                        const contextText = doc.splitTextToSize(cleanText(`Emotionnel: ${word.contexts[1]}`), 170);
                        doc.text(contextText, margin + 5, y);
                        y += contextText.length * 4;
                    }
                    
                    if (word.contexts[2]) {
                        const contextText = doc.splitTextToSize(cleanText(`Idiomatique: ${word.contexts[2]}`), 170);
                        doc.text(contextText, margin + 5, y);
                        y += contextText.length * 4;
                    }
                }
                
                // Note
                if (word.note) {
                    doc.setFontSize(9);
                    doc.setTextColor(107, 97, 92);
                    const noteText = doc.splitTextToSize(cleanText(`Note: ${word.note}`), 170);
                    doc.text(noteText, margin + 5, y);
                    y += noteText.length * 4;
                }
                
                y += 8; // Space between words
            });
            
            // Save the PDF
            doc.save(`vocabulaire-francais-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // PDF button visibility and click handler
        function updatePDFButtonVisibility() {
            const pdfBtn = document.getElementById('save-words-pdf');
            const csvBtn = document.getElementById('save-words-csv');
            const bulkBtn = document.getElementById('bulk-import-btn');
            const hasWords = getFilteredVocabulary().length > 0;
            
            if (pdfBtn) pdfBtn.style.display = hasWords ? 'flex' : 'none';
            if (csvBtn) csvBtn.style.display = hasWords ? 'flex' : 'none';
            if (bulkBtn) bulkBtn.style.display = 'flex'; // ALWAYS show import button!
        }

        document.getElementById('save-words-pdf').addEventListener('click', saveWordsAsPDF);

        // ============================================
        // CSV EXPORT FOR ANKI/QUIZLET
        // ============================================
        function saveWordsAsCSV() {
            const filteredVocabulary = getFilteredVocabulary();
            const sortedVocabulary = [...filteredVocabulary].sort((a, b) => b.id - a.id);
            
            // CSV Header
            let csvContent = "French,Meaning,Example Sentence,Theme,Week,Notes\n";
            
            // Add each word
            sortedVocabulary.forEach(word => {
                const french = word.article ? `${word.article} ${word.french}` : word.french;
                const meaning = word.meaning || '';
                const example = word.contexts && word.contexts[0] ? word.contexts[0] : '';
                const theme = word.theme || '';
                const week = word.week ? `Week ${word.week}` : '';
                const note = word.note || '';
                
                // Escape commas and quotes for CSV
                const escapeCsv = (str) => {
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };
                
                csvContent += `${escapeCsv(french)},${escapeCsv(meaning)},${escapeCsv(example)},${escapeCsv(theme)},${escapeCsv(week)},${escapeCsv(note)}\n`;
            });
            
            // Create download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `vocabulaire-francais-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('save-words-csv').addEventListener('click', saveWordsAsCSV);

        // ============================================
        // BULK IMPORT
        // ============================================
        document.getElementById('bulk-import-btn').addEventListener('click', () => {
            openModal('bulk-import-modal');
        });

        document.getElementById('bulk-import-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const text = document.getElementById('bulk-import-text').value.trim();
            const week = document.getElementById('bulk-week').value;
            const quarter = document.getElementById('bulk-quarter').value;
            const year = document.getElementById('bulk-year').value;
            const defaultTheme = document.getElementById('bulk-theme').value.trim();
            
            if (!text) return;
            
            const lines = text.split('\n').filter(line => line.trim());
            let imported = 0;
            let errors = [];
            
            lines.forEach((line, index) => {
                const parts = line.split('|').map(p => p.trim());
                
                if (parts.length < 2) {
                    errors.push(`Ligne ${index + 1}: Format invalide (besoin de au moins 2 parties)`);
                    return;
                }
                
                const french = parts[0];
                const meaning = parts[1];
                const lineTheme = parts[2] || ''; // Theme from the line itself
                const finalTheme = lineTheme || defaultTheme; // Use line theme if present, otherwise default
                
                // Detect article
                let article = '';
                let frenchWord = french;
                const articles = ['le ', 'la ', "l'", 'les ', 'un ', 'une ', 'des '];
                for (const art of articles) {
                    if (french.toLowerCase().startsWith(art)) {
                        article = art.trim();
                        frenchWord = french.substring(art.length).trim();
                        break;
                    }
                }
                
                const word = {
                    id: Date.now() + imported,
                    french: frenchWord,
                    article: article,
                    meaning: meaning,
                    theme: finalTheme,
                    week: week,
                    quarter: quarter,
                    year: year,
                    contexts: ['', '', ''],
                    note: '',
                    image: '',
                    created: new Date().toISOString(),
                    lastPracticed: null,
                    confidence: 0,
                    timesReviewed: 0
                };
                
                vocabulary.push(word);
                imported++;
            });
            
            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            renderWords();
            closeModal('bulk-import-modal');
            
            if (errors.length > 0) {
                alert(`ImportÃ© ${imported} mots.\n\nErreurs:\n${errors.join('\n')}`);
            } else {
                alert(`âœ¨ ${imported} mots importÃ©s avec succÃ¨s!`);
            }
            
            document.getElementById('bulk-import-form').reset();
        });

        // ============================================
        // MUSIC PLAYER MODAL
        // ============================================
        function setupMusicPlayer() {
            const modal = document.getElementById('music-modal');
            const audio = document.getElementById('background-music');
            const toggleBtn = document.getElementById('modal-music-toggle');
            const playIcon = toggleBtn?.querySelector('.play-icon');
            const pauseIcon = toggleBtn?.querySelector('.pause-icon');
            const volumeSlider = document.getElementById('modal-volume-slider');
            const trackName = document.getElementById('current-track-name');
            const trackItems = document.querySelectorAll('.music-track-item');

            if (!audio || !modal) return;

            // Set initial volume
            audio.volume = 0.5;

            // Load saved volume
            const savedVolume = localStorage.getItem('musicVolume');
            if (savedVolume && volumeSlider) {
                volumeSlider.value = savedVolume;
                audio.volume = savedVolume / 100;
            }

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // Toggle play/pause
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    if (audio.paused) {
                        if (!audio.src) {
                            alert('SÃ©lectionne d\'abord une piste dans la playlist');
                            return;
                        }
                        audio.play();
                        if (playIcon) playIcon.style.display = 'none';
                        if (pauseIcon) pauseIcon.style.display = 'block';
                        
                        // Start musical note animations
                        startMusicNoteAnimations();
                    } else {
                        audio.pause();
                        if (playIcon) playIcon.style.display = 'block';
                        if (pauseIcon) pauseIcon.style.display = 'none';
                        
                        // Stop musical note animations
                        stopMusicNoteAnimations();
                    }
                });
            }

            // Track selection
            trackItems.forEach(item => {
                item.addEventListener('click', () => {
                    const src = item.dataset.src;
                    const name = item.dataset.name;

                    // Update active state
                    trackItems.forEach(t => t.classList.remove('active'));
                    item.classList.add('active');

                    // Load and play
                    audio.src = src;
                    audio.load();
                    if (trackName) trackName.textContent = name;

                    audio.play().then(() => {
                        if (playIcon) playIcon.style.display = 'none';
                        if (pauseIcon) pauseIcon.style.display = 'block';
                        
                        // Start musical note animations
                        startMusicNoteAnimations();
                    }).catch(err => {
                        console.error('Playback error:', err);
                        alert('Fichier audio introuvable. Place les fichiers sound1.mp3, sound2.mp3, etc. dans le mÃªme dossier que cette page.');
                        if (playIcon) playIcon.style.display = 'block';
                        if (pauseIcon) pauseIcon.style.display = 'none';
                    });
                });
            });

            // Volume control
            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    audio.volume = e.target.value / 100;
                });

                volumeSlider.addEventListener('change', (e) => {
                    localStorage.setItem('musicVolume', e.target.value);
                });
            }

            // Handle audio errors
            audio.addEventListener('error', () => {
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
            });

            // Update playing indicator when audio ends
            audio.addEventListener('ended', () => {
                if (playIcon) playIcon.style.display = 'block';
                if (pauseIcon) pauseIcon.style.display = 'none';
            });
        }

        // ============================================
        // NAVIGATION
        // ============================================
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                const room = link.dataset.room;
                
                document.querySelectorAll('.room').forEach(r => r.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                document.getElementById(room).classList.add('active');
                link.classList.add('active');
            });
        });

        // ============================================
        // NOTES SECTION WITH EDIT
        // ============================================
        let activeNoteFilter = 'all';

        function renderNotes() {
            const grid = document.getElementById('notes-grid');
            
            const filteredNotes = activeNoteFilter === 'all' 
                ? notes 
                : notes.filter(n => n.category === activeNoteFilter);
            
            if (filteredNotes.length === 0) {
                grid.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">
                            <svg class="svg-icon-lg" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                            </svg>
                        </div>
                        <div class="empty-text">Rien ici encore...</div>
                    </div>
                `;
                return;
            }

            // Sort by most recent first
            const sortedNotes = [...filteredNotes].sort((a, b) => b.id - a.id);

            grid.innerHTML = sortedNotes.map(note => {
                const categoryColors = {
                    grammaire: 'var(--crimson)',
                    prononciation: 'var(--gold)',
                    phrases: 'var(--navy)',
                    vocabulaire: 'var(--rosy)',
                    culture: 'var(--sage)',
                    autre: 'var(--text-soft)'
                };
                
                const categoryColor = categoryColors[note.category] || 'var(--text-soft)';
                
                return `
                    <div class="note-card">
                        <div class="note-header">
                            <span class="note-category" style="background: ${categoryColor}20; color: ${categoryColor}; border-left: 3px solid ${categoryColor};">
                                ${note.category}
                            </span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="icon-btn" onclick="editNote(${note.id})" title="Modifier">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <button class="icon-btn" onclick="deleteNote(${note.id})">
                                    <svg class="svg-icon" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <h3 class="note-title">${note.title}</h3>
                        <div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>
                        ${note.link ? `
                            <a href="${note.link}" target="_blank" class="note-link">
                                <svg class="svg-icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;">
                                    <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
                                </svg>
                                Voir la ressource
                            </a>
                        ` : ''}
                        <div class="note-date">${new Date(note.created).toLocaleDateString('fr-FR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</div>
                    </div>
                `;
            }).join('');
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('edit-note-id').value = id;
            document.getElementById('edit-note-category').value = note.category;
            document.getElementById('edit-note-title').value = note.title;
            document.getElementById('edit-note-content').value = note.content;
            document.getElementById('edit-note-link').value = note.link || '';

            openModal('edit-note-modal');
        }

        function deleteNote(id) {
            if (confirm('Supprimer cette note ?')) {
                notes = notes.filter(n => n.id !== id);
                localStorage.setItem('notes', JSON.stringify(notes));
                renderNotes();
            }
        }

        // Note filter listeners
        document.querySelectorAll('[data-note-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                activeNoteFilter = btn.dataset.noteFilter;
                
                document.querySelectorAll('[data-note-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                renderNotes();
            });
        });

        // Note form submission
        document.getElementById('note-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const note = {
                id: Date.now(),
                category: document.getElementById('note-category').value,
                title: document.getElementById('note-title').value.trim(),
                content: document.getElementById('note-content').value.trim(),
                link: document.getElementById('note-link').value.trim(),
                created: new Date().toISOString()
            };

            notes.push(note);
            localStorage.setItem('notes', JSON.stringify(notes));
            
            renderNotes();
            closeModal('note-modal');
            
            // Reset form
            document.getElementById('note-form').reset();
        });

        // EDIT NOTE FORM SUBMISSION
        document.getElementById('edit-note-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('edit-note-id').value);
            const index = notes.findIndex(n => n.id === id);
            
            if (index === -1) return;

            notes[index] = {
                ...notes[index],
                category: document.getElementById('edit-note-category').value,
                title: document.getElementById('edit-note-title').value.trim(),
                content: document.getElementById('edit-note-content').value.trim(),
                link: document.getElementById('edit-note-link').value.trim()
            };

            // Validate required fields
            if (!notes[index].title || !notes[index].content) {
                alert('Veuillez remplir tous les champs requis');
                return;
            }

            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
            closeModal('edit-note-modal');
        });

        // ============================================
        // INITIALIZE - FIXED
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // EASTER EGGS
            const logoSub = document.getElementById('logo-sub');
            if (logoSub) {
                logoSub.addEventListener('click', () => {
                    logoSubClicks++;
                    clearTimeout(logoSubTimer);
                    logoSubTimer = setTimeout(() => { logoSubClicks = 0; }, 2000);
                    if (logoSubClicks === 3) {
                        logoSubClicks = 0;
                        document.getElementById('music-modal').classList.add('active');
                    }
                });
            }

            const logoMain = document.getElementById('logo-main');
            if (logoMain) {
                logoMain.addEventListener('click', () => {
                    logoMainClicks++;
                    clearTimeout(logoMainTimer);
                    logoMainTimer = setTimeout(() => { logoMainClicks = 0; }, 2000);
                    if (logoMainClicks === 2) {
                        logoMainClicks = 0;
                        document.body.classList.toggle('dark-mode');
                        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
                    }
                });
            }

            // Initialize SRS
            initializeSRSData();
            updateSRSStatsDisplay();

            // SRS button
            const startSRSBtn = document.getElementById('start-srs-session');
            if (startSRSBtn) {
                startSRSBtn.addEventListener('click', startSRSSession);
            }

            setupImportExport(); // Initialize import/export buttons
            setupTimer(); // Initialize study timer
            setupMusicPlayer(); // Initialize music player
            setupFloatingActions(); // Initialize floating quick actions
            setupFlipCards(); // Initialize flip cards
            renderEntrance();
            renderGarden();
            renderHeatmap(); // NEW: Render activity heatmap
            renderGardenVisual(); // NEW: Render garden visual
            populateJardinFilters(); // NEW
            setupFilterListeners(); // NEW
            renderReadingList();
            renderListeningList();
            renderRecordings();
            renderWritingsArchive();
            renderResourcesList();
            renderNotes();
            setupTranscriptSystem(); // Initialize transcript system
            
            // Resources filter listener
            const resourcesFilter = document.getElementById('filter-resources-type');
            if (resourcesFilter) {
                resourcesFilter.addEventListener('change', renderResourcesList);
            }
            
            // Fix: Properly attach event listener for add word button
            const addWordBtn = document.getElementById('add-word-btn');
            if (addWordBtn) {
                addWordBtn.addEventListener('click', function() {
                    openModal('word-modal');
                });
            }

            // Fix: Initialize image upload handlers
            setupImageUpload('word-image-upload', 'word-image-input', 'word-image-preview');
            setupImageUpload('edit-word-image-upload', 'edit-word-image-input', 'edit-word-image-preview');
            
            // Initialize speech recognition
            initializeSpeechRecognition();

            // Setup all button listeners
            setupReadingListeners();
            setupListeningListeners();
            setupResourcesListeners();

            // ============================================
            // DARK MODE TOGGLE
            // ============================================
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                // Start firefly animations if dark mode is enabled
            }

            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDark);
                    
                    // Toggle firefly animations based on dark mode
                    if (isDark) {
                    }
                });
            }

            document.getElementById('edit-resources-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-resources-id').value);
                const index = resourcesList.findIndex(r => r.id === id);
                
                if (index === -1) return;

                resourcesList[index] = {
                    ...resourcesList[index],
                    type: document.getElementById('edit-resources-type').value,
                    name: document.getElementById('edit-resources-name').value.trim(),
                    description: document.getElementById('edit-resources-description').value.trim() || '',
                    link: document.getElementById('edit-resources-link').value.trim(),
                    note: document.getElementById('edit-resources-note').value.trim() || ''
                };

                localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
                renderResourcesList();
                closeModal('edit-resources-modal');
            });

            document.getElementById('edit-note-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-note-id').value);
                const index = notes.findIndex(n => n.id === id);
                
                if (index === -1) return;

                notes[index] = {
                    ...notes[index],
                    category: document.getElementById('edit-note-category').value,
                    title: document.getElementById('edit-note-title').value.trim(),
                    content: document.getElementById('edit-note-content').value.trim(),
                    link: document.getElementById('edit-note-link').value.trim()
                };

                localStorage.setItem('notes', JSON.stringify(notes));
                renderNotes();
                closeModal('edit-note-modal');
            });

            document.getElementById('edit-recording-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-recording-id').value);
                const index = recordings.findIndex(r => r.id === id);
                
                if (index === -1) return;

                recordings[index] = {
                    ...recordings[index],
                    question: document.getElementById('edit-recording-question').value.trim(),
                    note: document.getElementById('edit-recording-note').value.trim() || ''
                };

                localStorage.setItem('recordings', JSON.stringify(recordings));
                renderRecordings();
                closeModal('edit-recording-modal');
            });

            document.getElementById('edit-writing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-writing-id').value);
                const index = writings.findIndex(w => w.id === id);
                
                if (index === -1) return;

                writings[index] = {
                    ...writings[index],
                    text: document.getElementById('edit-writing-text').value.trim()
                };

                localStorage.setItem('writings', JSON.stringify(writings));
                renderWritingsArchive();
                closeModal('edit-writing-modal');
            });
        });
        // ============================================
        // TRANSCRIPT SYSTEM WITH AI LOOKUP
        // ============================================
        
        // Storage
        let readingTranscripts = JSON.parse(localStorage.getItem('readingTranscripts') || '[]');
        let listeningTranscripts = JSON.parse(localStorage.getItem('listeningTranscripts') || '[]');
        let wordLookupCache = JSON.parse(localStorage.getItem('wordLookupCache') || '{}');
        
        // Current lookup state
        let currentLookup = null;

        // Normalize word for lookup
        function normalizeWord(word) {
            return word.toLowerCase()
                .replace(/['']/g, "'")  // normalize apostrophes
                .replace(/[.,!?;:]/g, '')  // remove punctuation
                .trim();
        }

        // Make transcript text clickable
        function makeTranscriptClickable(text, sourceId) {
            // Split into sentences to preserve structure
            const sentences = text.split(/([.!?]+\s)/);
            
            return sentences.map(sentence => {
                // Split sentence into words and punctuation
                const tokens = sentence.split(/(\s+|[''.,!?;:â€”])/);
                
                return tokens.map(token => {
                    // Skip whitespace and punctuation
                    if (!token.trim() || /^[''.,!?;:â€”\s]+$/.test(token)) {
                        return token;
                    }
                    
                    const normalized = normalizeWord(token);
                    if (!normalized) return token;
                    
                    return `<span class="clickable-word" data-word="${normalized}" data-source="${sourceId}">${token}</span>`;
                }).join('');
            }).join('');
        }

        // Render transcripts
        function renderTranscripts(type) {
            const transcripts = type === 'reading' ? readingTranscripts : listeningTranscripts;
            const container = document.getElementById(`${type}-transcripts-container`);
            const section = document.getElementById(`${type}-transcripts-section`);
            
            if (transcripts.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            container.innerHTML = transcripts.map(t => `
                <div class="transcript-card" data-transcript-id="${t.id}">
                    <div class="transcript-header">
                        <h3 class="transcript-title">${t.title}</h3>
                        <button class="icon-btn" onclick="deleteTranscript('${type}', ${t.id})" title="Supprimer">
                            <svg class="svg-icon" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="transcript-body">
                        ${makeTranscriptClickable(t.text, t.id)}
                    </div>
                </div>
            `).join('');
            
            // Attach click listeners to all clickable words
            container.querySelectorAll('.clickable-word').forEach(word => {
                word.addEventListener('click', function() {
                    handleWordClick(this);
                });
            });
        }

        // Handle word click
        async function handleWordClick(element) {
            const word = element.dataset.word;
            const sourceId = element.dataset.source;
            
            // Get sentence context
            const card = element.closest('.transcript-card');
            const fullText = card.querySelector('.transcript-body').textContent;
            
            // Find sentence containing the word
            const sentences = fullText.split(/[.!?]+/);
            let sentence = '';
            for (let s of sentences) {
                if (s.toLowerCase().includes(word)) {
                    sentence = s.trim();
                    break;
                }
            }
            
            // Open popup immediately
            openModal('word-lookup-modal');
            document.getElementById('lookup-word-title').textContent = word;
            document.getElementById('lookup-content').innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-soft);">Chargement...</div>';
            document.getElementById('lookup-actions').style.display = 'none';
            
            // Check cache first
            if (wordLookupCache[word]) {
                console.log('Using cached result for:', word);
                displayLookupResult(wordLookupCache[word], sentence, sourceId);
                return;
            }
            
            // Fetch from AI
            try {
                const result = await fetchWordDefinition(word, sentence);
                
                // Cache the result
                wordLookupCache[word] = result;
                localStorage.setItem('wordLookupCache', JSON.stringify(wordLookupCache));
                
                displayLookupResult(result, sentence, sourceId);
            } catch (error) {
                console.error('Lookup error:', error);
                document.getElementById('lookup-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--crimson);">
                        Impossible de charger la traduction.
                        <br><br>
                        <button class="btn btn-secondary" onclick="handleWordClick(document.querySelector('[data-word=\\'${word}\\']'))">
                            RÃ©essayer
                        </button>
                    </div>
                `;
            }
        }

        // Fetch word definition from free dictionary API
        async function fetchWordDefinition(word, sentence) {
            // Try free French dictionary API first
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/fr/${encodeURIComponent(word)}`);
                
                if (!response.ok) {
                    throw new Error('Dictionary API failed');
                }
                
                const data = await response.json();
                const entry = data[0];
                
                // Extract info
                const lemma = entry.word || word;
                const meanings = entry.meanings || [];
                const firstMeaning = meanings[0] || {};
                const partOfSpeech = firstMeaning.partOfSpeech || '';
                
                // Get definitions
                const definitions = firstMeaning.definitions || [];
                const translations = definitions.slice(0, 3).map(d => d.definition);
                
                // Get phonetics
                const phonetics = entry.phonetics || [];
                const ipa = phonetics.find(p => p.text)?.text || '';
                
                return {
                    lemma: lemma,
                    partOfSpeech: partOfSpeech,
                    translations: translations.length > 0 ? translations : ['(traduction non disponible)'],
                    ipa: ipa.replace(/[\/\[\]]/g, ''),
                    definition: definitions[0]?.definition || ''
                };
                
            } catch (error) {
                console.error('Dictionary API error:', error);
                
                // Fallback: basic response
                return {
                    lemma: word,
                    partOfSpeech: '',
                    translations: ['Cliquez sur "Sauvegarder" pour ajouter ce mot et ajouter la traduction manuellement'],
                    ipa: '',
                    definition: `Mot trouvÃ© dans: "${sentence}"`
                };
            }
        }

        // Display lookup result
        function displayLookupResult(result, sentence, sourceId) {
            currentLookup = { ...result, sentence, sourceId };
            
            const translationsList = result.translations.map(t => `<li>${t}</li>`).join('');
            
            document.getElementById('lookup-content').innerHTML = `
                <div class="lookup-info">
                    ${result.lemma ? `<div class="lookup-lemma"><strong>Lemme:</strong> ${result.lemma} <em>(${result.partOfSpeech || ''})</em></div>` : ''}
                    ${result.ipa ? `<div class="lookup-ipa">/${result.ipa}/</div>` : ''}
                    ${result.definition ? `<div style="margin-bottom: 1rem; color: var(--text-soft);">${result.definition}</div>` : ''}
                    <div>
                        <strong>Traductions:</strong>
                        <ul class="lookup-translations">
                            ${translationsList}
                        </ul>
                    </div>
                    <div class="lookup-sentence">
                        <strong>Contexte:</strong><br>
                        ${sentence}
                    </div>
                </div>
            `;
            
            document.getElementById('lookup-actions').style.display = 'flex';
        }

        // Save word to vocabulary
        document.getElementById('save-lookup-word')?.addEventListener('click', function() {
            if (!currentLookup) return;
            
            const word = {
                id: Date.now(),
                french: currentLookup.lemma || document.getElementById('lookup-word-title').textContent,
                meaning: currentLookup.translations.join(', '),
                article: '',
                gender: '',
                theme: 'De transcription',
                week: '',
                quarter: '',
                year: new Date().getFullYear().toString(),
                contexts: [currentLookup.sentence],
                note: currentLookup.definition || '',
                image: null,
                created: new Date().toISOString(),
                srs: {
                    easeFactor: 2.5,
                    interval: 0,
                    repetitions: 0,
                    dueDate: new Date().toISOString(),
                    lastReviewed: null,
                    status: 'new'
                }
            };
            
            vocabulary.push(word);
            localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
            renderGarden();
            updateSRSStatsDisplay();
            
            // Show confirmation
            document.getElementById('lookup-content').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--gold);">
                    âœ… Mot ajoutÃ© au jardin !
                </div>
            `;
            
            document.getElementById('lookup-actions').style.display = 'none';
            
            // Trigger hearts
            for (let i = 0; i < 3; i++) {
                setTimeout(() => createFloatingHeart(), i * 200);
            }
            
            setTimeout(() => closeModal('word-lookup-modal'), 1500);
        });

        // Delete transcript
        function deleteTranscript(type, id) {
            if (!confirm('Supprimer cette transcription ?')) return;
            
            if (type === 'reading') {
                readingTranscripts = readingTranscripts.filter(t => t.id !== id);
                localStorage.setItem('readingTranscripts', JSON.stringify(readingTranscripts));
                renderTranscripts('reading');
            } else {
                listeningTranscripts = listeningTranscripts.filter(t => t.id !== id);
                localStorage.setItem('listeningTranscripts', JSON.stringify(listeningTranscripts));
                renderTranscripts('listening');
            }
        }

        // Setup transcript buttons and forms
        function setupTranscriptSystem() {
            // Reading transcript button
            document.getElementById('add-reading-transcript-btn')?.addEventListener('click', () => {
                openModal('add-reading-transcript-modal');
            });
            
            // Listening transcript button
            document.getElementById('add-listening-transcript-btn')?.addEventListener('click', () => {
                openModal('add-listening-transcript-modal');
            });
            
            // Reading transcript form
            document.getElementById('add-reading-transcript-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const transcript = {
                    id: Date.now(),
                    title: document.getElementById('reading-transcript-title').value.trim(),
                    text: document.getElementById('reading-transcript-text').value.trim(),
                    translation: document.getElementById('reading-transcript-translation')?.value.trim() || '',
                    linkedMaterial: document.getElementById('reading-transcript-linked-material')?.value || '',
                    created: new Date().toISOString()
                };
                
                readingTranscripts.push(transcript);
                localStorage.setItem('readingTranscripts', JSON.stringify(readingTranscripts));
                renderTranscripts('reading');
                closeModal('add-reading-transcript-modal');
                
                e.target.reset();
            });
            
            // Listening transcript form
            document.getElementById('add-listening-transcript-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const transcript = {
                    id: Date.now(),
                    title: document.getElementById('listening-transcript-title').value.trim(),
                    text: document.getElementById('listening-transcript-text').value.trim(),
                    translation: document.getElementById('listening-transcript-translation')?.value.trim() || '',
                    linkedMaterial: document.getElementById('listening-transcript-linked-material')?.value || '',
                    created: new Date().toISOString()
                };
                
                listeningTranscripts.push(transcript);
                localStorage.setItem('listeningTranscripts', JSON.stringify(listeningTranscripts));
                renderTranscripts('listening');
                closeModal('add-listening-transcript-modal');
                
                e.target.reset();
            });
            
            // Initial render
            renderTranscripts('reading');
            renderTranscripts('listening');
        }

        // ============================================
        // FIREBASE AUTHENTICATION & CLOUD SYNC
        // ============================================
        
        let currentUser = null;
        
        // Wait for Firebase to load
        window.initFirebaseAuth = function() {
            console.log('ðŸ” initFirebaseAuth called');
            console.log('firebaseReady:', window.firebaseReady);
            console.log('firebaseAuth:', !!window.firebaseAuth);
            console.log('firebaseDB:', !!window.firebaseDB);
            
            if (!window.firebaseReady || !window.firebaseAuth || !window.firebaseDB) {
                console.log('â³ Waiting for Firebase to load... retrying in 100ms');
                setTimeout(window.initFirebaseAuth, 100);
                return;
            }
            
            console.log('ðŸ”¥ Initializing Firebase Auth...');
            
            const { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } = window.firebaseModules;
            
            // Listen for auth state changes
            onAuthStateChanged(window.firebaseAuth, (user) => {
                console.log('ðŸ‘¤ Auth state changed:', user ? user.email : 'Not logged in');
                
                if (user) {
                    currentUser = user;
                    
                    // Show entrance user profile
                    document.getElementById('entrance-user-profile').style.display = 'block';
                    document.getElementById('entrance-user-email').textContent = user.email;
                    document.getElementById('entrance-user-avatar').textContent = user.email[0].toUpperCase();
                    
                    // Hide entrance login section
                    document.getElementById('entrance-login-section').style.display = 'none';
                    
                    closeModal('auth-modal');
                    
                    // Load data from Firestore
                    loadDataFromFirebase(user.uid);
                    
                    // Setup real-time sync
                    setupRealtimeSync(user.uid);
                } else {
                    currentUser = null;
                    
                    // Hide entrance user profile
                    document.getElementById('entrance-user-profile').style.display = 'none';
                    
                    // Show entrance login section
                    document.getElementById('entrance-login-section').style.display = 'block';
                    
                    // Show login modal when not authenticated
                    setTimeout(() => {
                        console.log('ðŸ”“ Not logged in - showing auth modal');
                        openModal('auth-modal');
                    }, 500);
                }
            });
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Connexion...';
                submitBtn.disabled = true;
                
                try {
                    await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('âœ… Successfully logged in!');
                    // Modal will close automatically via onAuthStateChanged
                } catch (error) {
                    console.error('âŒ Login error:', error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    // Better error messages in French
                    let errorMsg = 'Erreur de connexion';
                    if (error.code === 'auth/user-not-found') {
                        errorMsg = 'Aucun compte trouvÃ© avec cet email. Voulez-vous crÃ©er un compte ?';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMsg = 'Mot de passe incorrect. RÃ©essayez.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Adresse email invalide.';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMsg = 'Email ou mot de passe incorrect.';
                    } else {
                        errorMsg = 'Erreur: ' + error.message;
                    }
                    alert(errorMsg);
                }
            });
            
            // Signup form
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'CrÃ©ation...';
                submitBtn.disabled = true;
                
                try {
                    await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('âœ… Account created successfully!');
                    // Modal will close automatically via onAuthStateChanged
                } catch (error) {
                    console.error('âŒ Signup error:', error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    
                    // Better error messages in French
                    let errorMsg = 'Erreur de crÃ©ation de compte';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMsg = 'Cet email est dÃ©jÃ  utilisÃ©. Essayez de vous connecter.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMsg = 'Le mot de passe doit contenir au moins 6 caractÃ¨res.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Adresse email invalide.';
                    } else {
                        errorMsg = 'Erreur: ' + error.message;
                    }
                    alert(errorMsg);
                }
            });
            
            // Google sign in
            document.getElementById('google-signin-btn').addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(window.firebaseAuth, provider);
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            });
            
            // Logout handler
            document.getElementById('entrance-logout-btn').addEventListener('click', async () => {
                await signOut(window.firebaseAuth);
            });
            
            // Toggle between login/signup
            document.getElementById('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('auth-login-view').style.display = 'none';
                document.getElementById('auth-signup-view').style.display = 'block';
                document.getElementById('auth-modal-title').textContent = 'CrÃ©er un compte';
            });
            
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('auth-signup-view').style.display = 'none';
                document.getElementById('auth-login-view').style.display = 'block';
                document.getElementById('auth-modal-title').textContent = 'Connexion';
            });
        }
        
        // Load all data from Firebase
        async function loadDataFromFirebase(userId) {
            const { doc, getDoc } = window.firebaseModules;
            
            try {
                const userDoc = await getDoc(doc(window.firebaseDB, 'users', userId));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // Load all data
                    if (data.vocabulary) {
                        vocabulary = data.vocabulary;
                        localStorage.setItem('vocabulary', JSON.stringify(vocabulary));
                        renderWords();
                    }
                    
                    if (data.readingList) {
                        readingList = data.readingList;
                        localStorage.setItem('readingList', JSON.stringify(readingList));
                        renderReadingList();
                    }
                    
                    if (data.listeningList) {
                        listeningList = data.listeningList;
                        localStorage.setItem('listeningList', JSON.stringify(listeningList));
                        renderListeningList();
                    }
                    
                    if (data.recordings) {
                        recordings = data.recordings;
                        localStorage.setItem('recordings', JSON.stringify(recordings));
                        renderRecordings();
                    }
                    
                    if (data.writings) {
                        writings = data.writings;
                        localStorage.setItem('writings', JSON.stringify(writings));
                        renderWritingsArchive();
                    }
                    
                    if (data.notes) {
                        notes = data.notes;
                        localStorage.setItem('notes', JSON.stringify(notes));
                        renderNotes();
                    }
                    
                    if (data.resourcesList) {
                        resourcesList = data.resourcesList;
                        localStorage.setItem('resourcesList', JSON.stringify(resourcesList));
                        renderResourcesList();
                    }
                    
                    console.log('âœ… Data loaded from Firebase!');
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
            }
        }
        
        // Save all data to Firebase
        async function saveDataToFirebase() {
            if (!currentUser) return;
            
            const { doc, setDoc } = window.firebaseModules;
            
            try {
                await setDoc(doc(window.firebaseDB, 'users', currentUser.uid), {
                    vocabulary,
                    readingList,
                    listeningList,
                    recordings,
                    writings,
                    notes,
                    resourcesList,
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('ðŸ’¾ Data saved to Firebase!');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
            }
        }
        
        // Setup real-time sync (debounced to avoid too many writes)
        let saveTimeout;
        function setupRealtimeSync(userId) {
            console.log('ðŸ”„ Setting up real-time sync for user:', userId);
            
            // Debounced save function
            window.syncToFirebase = function() {
                console.log('ðŸ“¤ Syncing to Firebase in 2 seconds...');
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveDataToFirebase();
                }, 2000); // Wait 2 seconds after last change
            };
            
            // Override localStorage.setItem to auto-sync
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                originalSetItem.apply(this, arguments);
                if (currentUser && ['vocabulary', 'readingList', 'listeningList', 'recordings', 'writings', 'notes', 'resourcesList'].includes(key)) {
                    console.log('ðŸ’« Auto-syncing after updating:', key);
                    window.syncToFirebase();
                }
            };
            
            console.log('âœ… Real-time sync is active!');
        }
        
        // ============================================
        // EMBEDDED MEDIA PLAYERS
        // ============================================
        
        function getEmbeddedPlayer(url) {
            if (!url) return '';
            
            // YouTube
            const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                const videoId = youtubeMatch[1];
                return `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 1rem 0;">
                    <iframe 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>`;
            }
            
            // Audio files (MP3, WAV, OGG)
            if (url.match(/\.(mp3|wav|ogg|m4a)(\?.*)?$/i)) {
                return `<div style="margin: 1rem 0;">
                    <audio controls style="width: 100%; max-width: 500px;">
                        <source src="${url}" type="audio/mpeg">
                        Votre navigateur ne supporte pas l'Ã©lÃ©ment audio.
                    </audio>
                </div>`;
            }
            
            // Video files (MP4, WEBM)
            if (url.match(/\.(mp4|webm|mov)(\?.*)?$/i)) {
                return `<div style="margin: 1rem 0;">
                    <video controls style="width: 100%; max-width: 600px; border-radius: 8px;">
                        <source src="${url}" type="video/mp4">
                        Votre navigateur ne supporte pas l'Ã©lÃ©ment vidÃ©o.
                    </video>
                </div>`;
            }
            
            return '';
        }
        
        // ============================================
        // AUTO-TRANSLATION (FREE API)
        // ============================================
        
        async function translateText(frenchText) {
            if (!frenchText.trim()) {
                alert('Veuillez entrer du texte Ã  traduire');
                return null;
            }
            
            try {
                // Using MyMemory Translation API (FREE, no key needed!)
                const response = await fetch(
                    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(frenchText)}&langpair=fr|en`
                );
                
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData) {
                    return data.responseData.translatedText;
                } else {
                    throw new Error('Translation failed');
                }
            } catch (error) {
                console.error('Translation error:', error);
                alert('Erreur de traduction. VÃ©rifiez votre connexion internet.');
                return null;
            }
        }
        
        // Translation button for reading transcripts
        const translateReadingBtn = document.getElementById('translate-reading-btn');
        if (translateReadingBtn) {
            translateReadingBtn.addEventListener('click', async () => {
                const frenchText = document.getElementById('reading-transcript-text').value;
                const translationField = document.getElementById('reading-transcript-translation');
                
                translateReadingBtn.disabled = true;
                translateReadingBtn.textContent = 'Traduction en cours...';
                
                const translation = await translateText(frenchText);
                
                if (translation) {
                    translationField.value = translation;
                }
                
                translateReadingBtn.disabled = false;
                translateReadingBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8M10 14h4"></path>
                    </svg>
                    Traduire automatiquement
                `;
            });
        }
        
        // Translation button for listening transcripts
        const translateListeningBtn = document.getElementById('translate-listening-btn');
        if (translateListeningBtn) {
            translateListeningBtn.addEventListener('click', async () => {
                const frenchText = document.getElementById('listening-transcript-text').value;
                const translationField = document.getElementById('listening-transcript-translation');
                
                translateListeningBtn.disabled = true;
                translateListeningBtn.textContent = 'Traduction en cours...';
                
                const translation = await translateText(frenchText);
                
                if (translation) {
                    translationField.value = translation;
                }
                
                translateListeningBtn.disabled = false;
                translateListeningBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8M10 14h4"></path>
                    </svg>
                    Traduire automatiquement
                `;
            });
        }
        
        // ============================================
        // TRANSCRIPTION LINKING
        // ============================================
        
        // Populate dropdowns with existing materials when opening transcript modals
        function populateTranscriptLinkingDropdowns() {
            // For reading transcripts - link to reading materials
            const readingDropdown = document.getElementById('reading-transcript-linked-material');
            if (readingDropdown && readingList) {
                readingDropdown.innerHTML = '<option value="">Aucun lien</option>';
                readingList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    readingDropdown.appendChild(option);
                });
            }
            
            // For listening transcripts - link to listening materials
            const listeningDropdown = document.getElementById('listening-transcript-linked-material');
            if (listeningDropdown && listeningList) {
                listeningDropdown.innerHTML = '<option value="">Aucun lien</option>';
                listeningList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    listeningDropdown.appendChild(option);
                });
            }
        }
        
        // Populate listening form with existing transcripts
        function populateListeningTranscriptDropdown() {
            const dropdown = document.getElementById('listening-linked-transcript');
            if (dropdown && listeningTranscripts) {
                dropdown.innerHTML = '<option value="">Aucune transcription</option>';
                listeningTranscripts.forEach(transcript => {
                    const option = document.createElement('option');
                    option.value = transcript.id;
                    option.textContent = transcript.title;
                    dropdown.appendChild(option);
                });
            }
        }
        
        // Call these when opening modals
        document.querySelectorAll('[onclick*="add-reading-transcript-modal"]').forEach(btn => {
            btn.addEventListener('click', populateTranscriptLinkingDropdowns);
        });
        
        document.querySelectorAll('[onclick*="add-listening-transcript-modal"]').forEach(btn => {
            btn.addEventListener('click', populateTranscriptLinkingDropdowns);
        });
        
        document.getElementById('add-listening-btn')?.addEventListener('click', populateListeningTranscriptDropdown);

        // Initialize Firebase Auth (Firebase module will call this when ready)
        console.log('ðŸ“‹ initFirebaseAuth function defined and ready');

    </script>

    <!-- Floating Quick Actions -->
    <div class="floating-actions" id="floating-actions">
        <button class="floating-btn-main" id="floating-main" aria-label="Quick actions">
            <svg class="plus-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>

        <div class="floating-menu" id="floating-menu">
            <button class="floating-btn-action" id="quick-add-word" title="Ajouter un mot">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22c4.97 0 9-4.03 9-9-4.97 0-9 4.03-9 9zM5.6 10.25c0 1.38 1.12 2.5 2.5 2.5.53 0 1.01-.16 1.42-.44l-.02.19c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5l-.02-.19c.4.28.89.44 1.42.44 1.38 0 2.5-1.12 2.5-2.5 0-1.25-.93-2.3-2.14-2.46.4-.49.64-1.1.64-1.79 0-1.38-1.12-2.5-2.5-2.5-.53 0-1.01.16-1.42.44l.02-.19C12.5 2.12 11.38 1 10 1S7.5 2.12 7.5 3.5l.02.19c-.4-.28-.89-.44-1.42-.44-1.38 0-2.5 1.12-2.5 2.5 0 .69.24 1.3.64 1.79-1.21.16-2.14 1.21-2.14 2.46z"/>
                </svg>
                <span>Mot</span>
            </button>

            <button class="floating-btn-action" id="quick-start-timer" title="DÃ©marrer le minuteur">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>Timer</span>
            </button>

            <button class="floating-btn-action" id="quick-flip-cards" title="Pratiquer avec cartes">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                <span>Cartes</span>
            </button>
        </div>
    </div>

    <!-- Music Player Modal -->
    <div class="music-modal" id="music-modal">
        <div class="music-modal-content">
            <button class="music-modal-close" id="close-music-modal" onclick="document.getElementById('music-modal').classList.remove('active')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="music-modal-title">Musique d'ambiance</div>
            <div class="music-modal-subtitle">Ã‰tudie avec des sons apaisants</div>

            <div class="music-player-card">
                <div class="music-album-art">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                    <div class="music-wave"></div>
                </div>

                <div class="music-now-playing">
                    <div class="music-track-name" id="current-track-name">SÃ©lectionne une piste</div>
                    <div class="music-track-artist">Musique d'Ã©tude</div>
                </div>

                <div class="music-controls-main">
                    <button class="music-play-btn" id="modal-music-toggle">
                        <svg class="play-icon" viewBox="0 0 24 24">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <svg class="pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    </button>
                </div>

                <div class="music-volume-section">
                    <svg class="music-volume-icon" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2" fill="none"></path>
                    </svg>
                    <input type="range" class="music-volume-slider" id="modal-volume-slider" min="0" max="100" value="50">
                </div>
            </div>

            <div class="music-playlist">
                <div class="music-playlist-title">Playlist</div>
                
                <div class="music-track-item" data-src="sound1.mp3" data-name="Ambient Study">
                    <div class="music-track-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="2"></circle>
                            <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path>
                        </svg>
                    </div>
                    <div class="music-track-info">
                        <div class="music-track-info-name">Ambient Study</div>
                        <div class="music-track-info-duration">Lofi ambiance</div>
                    </div>
                </div>

                <div class="music-track-item" data-src="sound2.mp3" data-name="Peaceful Piano">
                    <div class="music-track-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 2v19.5L3 18v-3h-.5A2.5 2.5 0 0 1 0 12.5v-9A2.5 2.5 0 0 1 2.5 1H3a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1zM0 12.5v.5h2.5a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5H0v2.5z"></path>
                        </svg>
                    </div>
                    <div class="music-track-info">
                        <div class="music-track-info-name">Peaceful Piano</div>
                        <div class="music-track-info-duration">Piano classique</div>
                    </div>
                </div>

                <div class="music-track-item" data-src="sound3.mp3" data-name="Nature Sounds">
                    <div class="music-track-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.30C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"></path>
                        </svg>
                    </div>
                    <div class="music-track-info">
                        <div class="music-track-info-name">Nature Sounds</div>
                        <div class="music-track-info-duration">ForÃªt & oiseaux</div>
                    </div>
                </div>

                <div class="music-track-item" data-src="sound4.mp3" data-name="Lo-fi Beats">
                    <div class="music-track-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 3h-2v4h2V3zM10 3H8v4h2V3z"></path>
                        </svg>
                    </div>
                    <div class="music-track-info">
                        <div class="music-track-info-name">Lo-fi Beats</div>
                        <div class="music-track-info-duration">Chill hip-hop</div>
                    </div>
                </div>

                <div class="music-track-item" data-src="sound5.mp3" data-name="CafÃ© Ambiance">
                    <div class="music-track-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"></path>
                        </svg>
                    </div>
                    <div class="music-track-info">
                        <div class="music-track-info-name">CafÃ© Ambiance</div>
                        <div class="music-track-info-duration">CafÃ© parisien</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden audio element -->
    <audio id="background-music" loop></audio>

    <!-- Firebase Auth Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title" id="auth-modal-title">Connexion</h2>
                <button class="close-btn" onclick="closeModal('auth-modal')">&times;</button>
            </div>
            
            <div id="auth-login-view">
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="login-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
                    </div>
                </form>
                
                <div style="text-align: center; margin: 1.5rem 0; color: var(--text-soft);">ou</div>
                
                <button class="btn btn-secondary" id="google-signin-btn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    Continuer avec Google
                </button>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <a href="#" id="show-signup" style="color: var(--crimson); text-decoration: none;">Pas encore de compte ? S'inscrire</a>
                </div>
            </div>
            
            <div id="auth-signup-view" style="display: none;">
                <form id="signup-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="signup-password" required minlength="6">
                        <small style="color: var(--text-soft);">Minimum 6 caractÃ¨res</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">CrÃ©er un compte</button>
                    </div>
                </form>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <a href="#" id="show-login" style="color: var(--crimson); text-decoration: none;">DÃ©jÃ  un compte ? Se connecter</a>
                </div>
            </div>
        </div>
    </div>

</body>
</html>